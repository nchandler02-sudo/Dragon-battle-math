<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4A1A8A">
<title>üêâ Dragon Math Academy</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap');
:root{--purple:#4A1A8A;--purple-m:#6B3FA0;--purple-l:#9B6FD0;--purple-p:#D4BEF0;--gold:#F5C542;--gold-d:#D4A017;--gold-l:#FFE082;--white:#F9F6FF;--green:#2ECC71;--green-d:#27AE60;--red:#E74C3C;--red-d:#C0392B;--blue:#3498DB;--flame:#FF6B35;--bg:linear-gradient(135deg,#1a0533,#2d1b4e 30%,#1a0533);--card:rgba(255,255,255,.08);--cardb:rgba(255,255,255,.12);--r:16px;--f:'Nunito',sans-serif;--fd:'Fredoka One',cursive}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:var(--f);background:var(--bg);background-attachment:fixed;color:var(--white);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(1px 1px at 10% 20%,rgba(255,255,255,.3),transparent),radial-gradient(1.5px 1.5px at 50% 10%,rgba(245,197,66,.3),transparent),radial-gradient(1px 1px at 70% 40%,rgba(255,255,255,.25),transparent),radial-gradient(1px 1px at 80% 80%,rgba(255,255,255,.2),transparent);pointer-events:none;z-index:0;animation:twinkle 8s ease-in-out infinite alternate}
@keyframes twinkle{0%{opacity:.6}100%{opacity:1}}
#app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100dvh;max-width:500px;margin:0 auto}
#top-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:rgba(74,26,138,.9);backdrop-filter:blur(12px);border-bottom:2px solid rgba(245,197,66,.3);position:sticky;top:0;z-index:100}
#top-bar.hidden{display:none}
.tbl,.tbr{display:flex;align-items:center;gap:8px}
.pname{font-family:var(--fd);font-size:1rem;color:var(--gold)}
.rbadge{font-size:.65rem;background:var(--purple-m);color:var(--purple-p);padding:2px 8px;border-radius:20px;font-weight:700}
.pill{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-weight:800;font-size:.82rem}
.xp-p{background:linear-gradient(135deg,#2d1b4e,#4A1A8A);border:1.5px solid var(--purple-l);color:var(--purple-p)}
.co-p{background:linear-gradient(135deg,#5c3d10,#8B6914);border:1.5px solid var(--gold);color:var(--gold-l)}
#scr{flex:1;padding:16px;padding-bottom:80px;overflow-y:auto}
#bnav{display:flex;justify-content:space-around;align-items:center;padding:6px 8px 14px;background:rgba(74,26,138,.95);backdrop-filter:blur(12px);border-top:2px solid rgba(245,197,66,.3);position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:500px;z-index:100}
#bnav.hidden{display:none}
.nb{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;color:var(--purple-p);cursor:pointer;padding:6px 12px;border-radius:12px;transition:.15s;font-family:var(--f)}
.nb .ni{font-size:1.3rem}.nb .nl{font-size:.6rem;font-weight:700}
.nb.act{color:var(--gold);background:rgba(245,197,66,.15)}
.nb:active{transform:scale(.9)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 28px;border:none;border-radius:var(--r);font-family:var(--fd);font-size:1.05rem;cursor:pointer;transition:.15s}
.btn:active{transform:scale(.95)}.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}
.bp{background:linear-gradient(135deg,var(--gold),var(--gold-d));color:#2D1050;box-shadow:0 4px 16px rgba(245,197,66,.4)}
.bs{background:linear-gradient(135deg,var(--purple-m),var(--purple));color:var(--white);border:2px solid var(--purple-l)}
.bd{background:linear-gradient(135deg,var(--red),var(--red-d));color:#fff}
.bsm{padding:8px 16px;font-size:.82rem;border-radius:12px}
.blg{padding:18px 36px;font-size:1.3rem;border-radius:24px}
.ib{background:none;border:none;font-size:1.2rem;cursor:pointer;padding:4px}
.card{background:var(--card);border:1.5px solid var(--cardb);border-radius:var(--r);padding:20px;box-shadow:0 4px 16px rgba(0,0,0,.2);backdrop-filter:blur(8px)}
.cg{border-color:rgba(245,197,66,.4);box-shadow:0 4px 16px rgba(0,0,0,.2),0 0 20px rgba(245,197,66,.3)}
.pc{background:var(--card);border:2px solid var(--cardb);border-radius:20px;padding:24px;text-align:center;cursor:pointer;transition:.3s}
.pc:hover{border-color:var(--gold);transform:translateY(-4px);box-shadow:0 0 20px rgba(245,197,66,.3)}
.pc .av{font-size:3rem;margin-bottom:8px;display:block}.pc .pn{font-family:var(--fd);font-size:1.1rem;color:var(--gold)}.pc .li{font-size:.75rem;opacity:.7;margin-top:4px}
.pc.np{border-style:dashed;border-color:var(--purple-l);opacity:.7}.pc.np:hover{opacity:1}
.inf{width:100%;padding:14px 18px;border:2px solid var(--purple-l);border-radius:var(--r);background:rgba(255,255,255,.08);color:var(--white);font-family:var(--f);font-size:1.1rem;font-weight:600}
.inf:focus{outline:none;border-color:var(--gold);box-shadow:0 0 12px rgba(245,197,66,.3)}.inf::placeholder{color:var(--purple-p);opacity:.5}
.np-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:300px;margin:12px auto}
.npb{padding:16px;font-family:var(--fd);font-size:1.5rem;border:2px solid var(--purple-l);border-radius:var(--r);background:rgba(255,255,255,.06);color:var(--white);cursor:pointer;transition:.15s}
.npb:hover{background:rgba(245,197,66,.15);border-color:var(--gold)}.npb:active{transform:scale(.92);background:rgba(245,197,66,.3)}
.npb.ne{background:linear-gradient(135deg,var(--green),var(--green-d));border-color:var(--green);color:#fff}
.npb.nb2{background:rgba(231,76,60,.2);border-color:var(--red);color:var(--red)}
.tc{width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin:8px 0}
.tb{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:4px;transition:width .1s linear}
.tb.tw{background:linear-gradient(90deg,var(--gold),var(--flame))}.tb.td{background:linear-gradient(90deg,var(--red),var(--flame))}
.hpc{width:100%;height:18px;background:rgba(0,0,0,.3);border-radius:9px;overflow:hidden;border:1.5px solid rgba(255,255,255,.15);position:relative}
.hpb{height:100%;border-radius:9px;transition:width .5s ease}
.hh{background:linear-gradient(90deg,#2ECC71,#27AE60)}.hm{background:linear-gradient(90deg,#F5C542,#F39C12)}.hl{background:linear-gradient(90deg,#E74C3C,#C0392B)}
.hpt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;text-shadow:0 1px 3px rgba(0,0,0,.6);z-index:2}
.dots{display:flex;justify-content:center;gap:6px;margin:10px 0}
.dot{width:12px;height:12px;border-radius:50%;border:2px solid var(--purple-l);background:transparent}
.dot.c{background:var(--green);border-color:var(--green)}.dot.w{background:var(--red);border-color:var(--red)}.dot.cur{border-color:var(--gold);box-shadow:0 0 8px rgba(245,197,66,.5)}
.lr{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.ln{width:52px;height:52px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:var(--fd);font-size:.95rem;cursor:pointer;transition:.15s;border:2.5px solid}
.ln .st{font-size:.45rem;margin-top:1px}
.ln.lk{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.1);color:rgba(255,255,255,.25);cursor:not-allowed}
.ln.av{background:linear-gradient(135deg,var(--purple-m),var(--purple));border-color:var(--gold);color:var(--gold);animation:pulse 2s ease-in-out infinite}
.ln.cm{background:rgba(46,204,113,.2);border-color:var(--green);color:var(--green)}
.ln.pf{background:rgba(245,197,66,.15);border-color:var(--gold);color:var(--gold)}
.ln:not(.lk):hover{transform:scale(1.12)}
@keyframes pulse{0%,100%{box-shadow:0 0 8px rgba(245,197,66,.3)}50%{box-shadow:0 0 20px rgba(245,197,66,.6)}}
.dc{border-radius:20px;padding:14px;text-align:center;cursor:pointer;transition:.3s;background:var(--card)}
.dc:hover{transform:translateY(-3px)}.dc .de{font-size:2.8rem;display:block;margin-bottom:6px}.dc .dn{font-family:var(--fd);font-size:.85rem}.dc .dl{font-size:.7rem;opacity:.7}
.dc.sel{border:2.5px solid var(--gold)!important;box-shadow:0 0 20px rgba(245,197,66,.4)}
.rb{border:2px solid #A0A0A0}.rm{border:2px solid #3498DB}.rr{border:2px solid #9B59B6}.ru{border:2px solid var(--gold);background:linear-gradient(135deg,rgba(245,197,66,.08),rgba(255,107,53,.08))}
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px}
.ac{display:flex;align-items:center;gap:14px;padding:16px;margin-bottom:10px;border-radius:var(--r);background:var(--card);border:1.5px solid var(--cardb);cursor:pointer;transition:.3s}
.ac:hover:not(.al){border-color:var(--gold);transform:translateY(-2px)}.ac.al{opacity:.4;cursor:not-allowed}
.tg{display:grid;grid-template-columns:repeat(auto-fill,minmax(85px,1fr));gap:8px}
.ti{background:var(--card);border:1.5px solid var(--cardb);border-radius:var(--r);padding:10px 6px;text-align:center}
.ti.ul{border-color:var(--gold);background:rgba(245,197,66,.08)}.ti.lo{opacity:.3;filter:grayscale(1)}
.ti .tic{font-size:1.6rem;display:block;margin-bottom:3px}.ti .tn{font-size:.6rem;font-weight:700;line-height:1.2}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px;animation:fi .2s}
.mc{background:linear-gradient(135deg,#2d1b4e,#1a0533);border:2px solid var(--gold);border-radius:28px;padding:32px 24px;max-width:380px;width:100%;text-align:center;animation:mp .3s;box-shadow:0 0 40px rgba(245,197,66,.2)}
.mc h2{font-family:var(--fd);color:var(--gold);margin-bottom:12px}
.sh{font-family:var(--fd);font-size:1.3rem;color:var(--gold);margin-bottom:14px;text-align:center}
.ss{font-size:.85rem;color:var(--purple-p);text-align:center;margin-bottom:14px;opacity:.8}
.ob{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center;padding:24px}
.ob h1{font-family:var(--fd);font-size:1.7rem;color:var(--gold);margin-bottom:10px}
.ob p{font-size:1rem;margin-bottom:20px;opacity:.9;line-height:1.5}
.ob .ms{font-size:5rem;margin-bottom:14px;animation:bi .8s}
.ab{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:14px 0}
.abtn{width:54px;height:54px;border-radius:50%;font-family:var(--fd);font-size:1.3rem;border:2.5px solid var(--purple-l);background:var(--card);color:var(--white);cursor:pointer;transition:.15s}
.abtn:hover,.abtn.sel{border-color:var(--gold);background:rgba(245,197,66,.2);color:var(--gold);transform:scale(1.1)}
.dcar{display:flex;gap:12px;overflow-x:auto;padding:14px 8px;scroll-snap-type:x mandatory}.dcar::-webkit-scrollbar{display:none}.dcar .dc{min-width:120px;scroll-snap-align:center;flex-shrink:0}
.trc{background:var(--card);border:2px solid var(--cardb);border-radius:20px;padding:22px 18px;cursor:pointer;transition:.3s}
.trc:hover{border-color:var(--gold);transform:translateY(-3px);box-shadow:0 0 20px rgba(245,197,66,.3)}
.trc h3{font-family:var(--fd);font-size:1.05rem;color:var(--gold);margin-bottom:6px}.trc p{font-size:.82rem;opacity:.8;line-height:1.4}
.tp{margin-top:8px;font-size:.78rem;color:var(--green);font-weight:700}
.sr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.tgl{position:relative;width:48px;height:26px;cursor:pointer;display:inline-block}.tgl input{display:none}
.tgl .sl{position:absolute;inset:0;background:rgba(255,255,255,.15);border-radius:26px;transition:.15s}
.tgl .sl::before{content:'';position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;top:3px;left:3px;transition:.15s}
.tgl input:checked+.sl{background:var(--green)}.tgl input:checked+.sl::before{transform:translateX(22px)}
.cfw{position:fixed;inset:0;pointer-events:none;z-index:9998;overflow:hidden}
.cfp{position:absolute;width:10px;height:10px;top:-10px;animation:cff var(--dur) ease-in forwards}
@keyframes cff{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(var(--rot));opacity:0}}
.sbw{position:fixed;pointer-events:none;z-index:9999}.sp{position:absolute;font-size:1.1rem;animation:sf .7s ease-out forwards}
@keyframes sf{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes bi{0%{transform:scale(0)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
@keyframes mp{0%{transform:scale(.8);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes sx{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.hidden{display:none!important}.tc2{text-align:center}.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}.wf{width:100%}
*:focus-visible{outline:3px solid var(--gold);outline-offset:2px}
@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}}
@media(max-width:350px){.npb{padding:12px;font-size:1.2rem}.ln{width:44px;height:44px;font-size:.8rem}}
</style>
</head>
<body>
<div id="app">
<header id="top-bar" class="hidden"><div class="tbl"><span id="pnd" class="pname"></span><span id="rb" class="rbadge"></span></div><div class="tbr"><span class="pill xp-p">‚ö°<span id="xa">0</span></span><span class="pill co-p">ü™ô<span id="ca">0</span></span><button id="mb" class="ib">üîä</button></div></header>
<main id="scr"></main>
<nav id="bnav" class="hidden"><button class="nb act" data-t="play"><span class="ni">üéÆ</span><span class="nl">Play</span></button><button class="nb" data-t="arena"><span class="ni">‚öîÔ∏è</span><span class="nl">Arena</span></button><button class="nb" data-t="dragons"><span class="ni">üêâ</span><span class="nl">Dragons</span></button><button class="nb" data-t="trophies"><span class="ni">üèÜ</span><span class="nl">Trophies</span></button><button class="nb" data-t="settings"><span class="ni">‚öôÔ∏è</span><span class="nl">Settings</span></button></nav>
</div>
<style>
/* Phase 2 additions */
.boss-intro{position:fixed;inset:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:999;animation:fi .5s}
.boss-intro .bname{font-family:var(--fd);font-size:1.8rem;color:var(--red);animation:bi 1s;margin-top:16px}
.boss-intro .bemoji{font-size:5rem;animation:bi .8s}
.boss-intro .bability{font-size:.85rem;color:var(--gold);margin-top:8px;opacity:.8}
@keyframes screenShake{0%,100%{transform:translate(0)}25%{transform:translate(-4px,2px)}50%{transform:translate(4px,-2px)}75%{transform:translate(-2px,4px)}}
.shake{animation:screenShake .3s}
.vs-splash{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:998;animation:fi .3s}
.vs-splash .vs-text{font-family:var(--fd);font-size:3rem;color:var(--red);animation:bi .5s}
.privacy-shield{position:fixed;inset:0;background:linear-gradient(135deg,#1a0533,#2d1b4e);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:997;animation:fi .3s}
.privacy-shield h2{font-family:var(--fd);color:var(--gold);font-size:1.3rem;margin-bottom:8px}
.taunt-popup{position:fixed;top:20%;left:50%;transform:translateX(-50%);background:rgba(74,26,138,.95);border:2px solid var(--gold);border-radius:20px;padding:14px 24px;font-size:1rem;z-index:996;animation:bi .3s}
.grade-card{background:var(--card);border:2px solid var(--cardb);border-radius:20px;padding:18px;cursor:pointer;transition:.3s;margin-bottom:10px}
.grade-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.grade-card h3{font-family:var(--fd);font-size:1rem;margin-bottom:4px}
.grade-card p{font-size:.8rem;opacity:.8}
.mc-opt{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
.mc-btn{padding:14px;border:2px solid var(--purple-l);border-radius:var(--r);background:var(--card);color:var(--white);font-family:var(--fd);font-size:1.1rem;cursor:pointer;transition:.15s;text-align:center}
.mc-btn:hover{border-color:var(--gold);background:rgba(245,197,66,.1)}
.mc-btn:active{transform:scale(.95)}
.mc-btn.mc-correct{border-color:var(--green);background:rgba(46,204,113,.2);color:var(--green)}
.mc-btn.mc-wrong{border-color:var(--red);background:rgba(231,76,60,.2);color:var(--red)}
.replay-bar{display:flex;align-items:center;gap:8px;margin:8px 0}
.replay-bar .rprog{flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
.replay-bar .rprog-fill{height:100%;background:var(--gold);border-radius:3px;transition:width .3s}
.challenge-code{font-family:var(--fd);font-size:1.5rem;color:var(--gold);letter-spacing:4px;background:rgba(0,0,0,.3);padding:12px 20px;border-radius:12px;border:2px dashed var(--gold);display:inline-block;margin:12px 0;user-select:all}
.potd-card{background:linear-gradient(135deg,rgba(245,197,66,.1),rgba(255,107,53,.05));border:2px solid rgba(245,197,66,.3);border-radius:20px;padding:16px;text-align:center;margin-bottom:14px;cursor:pointer;transition:.3s}
.potd-card:hover{border-color:var(--gold);transform:translateY(-2px)}
.weekly-card{background:var(--card);border:1.5px solid var(--cardb);border-radius:16px;padding:14px;margin-bottom:8px}
.wc-check{color:var(--green);font-weight:800}
.parent-stat{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:.85rem}
</style>
<script>
// === DATA ===
const RANKS=[{t:0,title:'Math Apprentice'},{t:500,title:'Number Knight'},{t:1500,title:'Equation Warrior'},{t:3500,title:'Formula Mage'},{t:6000,title:'Calculation Champion'},{t:10000,title:'Dragon Mathematician'}];
const EL={flame:{i:'üî•',n:'Flame',c:'#FF6B35',pw:'Fireball Surge'},tide:{i:'üåä',n:'Tide',c:'#3498DB',pw:'Tidal Shield'},forest:{i:'üåø',n:'Forest',c:'#2ECC71',pw:"Nature's Heal"},storm:{i:'‚ö°',n:'Storm',c:'#F39C12',pw:'Lightning Reflexes'},frost:{i:'‚ùÑÔ∏è',n:'Frost',c:'#85C1E9',pw:'Frozen Time'},shadow:{i:'üåë',n:'Shadow',c:'#8E44AD',pw:'Shadow Strike'}};
const EA={flame:'forest',forest:'storm',storm:'tide',tide:'flame'};
function em(a,d){if(EA[a]===d)return 1.25;if(EA[d]===a)return .75;return 1;}
const RA={basic:{l:'Basic',cost:20},medium:{l:'Medium',cost:60},rare:{l:'Rare',cost:150},ultra:{l:'Ultra Rare',cost:400}};
const DR=[
{id:1,n:'Emberpuff',e:'flame',r:'basic',pw:12,sp:8,wi:5,ch:10,hp:80,fl:['A tiny dragon that sneezes sparks!','Shooting fireballs on purpose now!','Volcanoes bow to Emberpuff.'],em:'üî•'},
{id:2,n:'Scorchscale',e:'flame',r:'medium',pw:28,sp:15,wi:12,ch:8,hp:120,fl:['Burns the wrong answers.','Wrong answers don\'t stand a chance.','The ultimate answer eliminator.'],em:'üî•'},
{id:3,n:'Blazefang',e:'flame',r:'rare',pw:45,sp:30,wi:25,ch:18,hp:180,fl:['Heated an entire school!','Heats entire cities now.','The sun asks for warmth advice.'],em:'üî•'},
{id:4,n:'Infernothorn',e:'flame',r:'rare',pw:50,sp:22,wi:35,ch:12,hp:190,fl:['Counts by lighting candles.','Candles light themselves.','Stars dim in respect.'],em:'üî•'},
{id:5,n:'Volcanius',e:'flame',r:'ultra',pw:85,sp:50,wi:60,ch:40,hp:300,fl:['Born from a volcano during a math test.','The volcano erupts on command.','Volcanoes are just Volcanius sneezing.'],em:'üåã'},
{id:6,n:'Splashling',e:'tide',r:'basic',pw:6,sp:14,wi:8,ch:15,hp:85,fl:['Makes puddles everywhere!','Puddles are suspiciously organized.','Oceans part respectfully.'],em:'üåä'},
{id:7,n:'Coralcrunch',e:'tide',r:'medium',pw:18,sp:22,wi:20,ch:14,hp:115,fl:['Built an underwater calculator.','Calculator runs on tidal energy.','Invented waterproof math.'],em:'üåä'},
{id:8,n:'Tidalwhip',e:'tide',r:'rare',pw:38,sp:42,wi:28,ch:22,hp:170,fl:['Multiplies by making waves.','Waves form equation shapes.','Tsunamis solve calculus.'],em:'üåä'},
{id:9,n:'Abyssmaw',e:'tide',r:'rare',pw:48,sp:35,wi:40,ch:10,hp:200,fl:['Uses bioluminescence for equations.','The deep sea glows with math.','The abyss learned to count.'],em:'üåä'},
{id:10,n:'Tsunarax',e:'tide',r:'ultra',pw:78,sp:60,wi:70,ch:35,hp:290,fl:['Controls all ocean currents.','Figured out how to stay dry.','The ocean is a math notebook.'],em:'üåä'},
{id:11,n:'Mossywing',e:'forest',r:'basic',pw:5,sp:7,wi:14,ch:12,hp:90,fl:['Photosynthesizes during math class.','Teaches plants algebra.','Forests grow wherever it studies.'],em:'üåø'},
{id:12,n:'Thornvine',e:'forest',r:'medium',pw:20,sp:12,wi:25,ch:16,hp:125,fl:['New thorn for every correct answer.','Running out of room for thorns.','A walking forest of achievement.'],em:'üåø'},
{id:13,n:'Willowshade',e:'forest',r:'medium',pw:15,sp:18,wi:30,ch:22,hp:110,fl:['Others ask for homework help.','Now tutoring the tutors.','Wisdom leaks like morning dew.'],em:'üåø'},
{id:14,n:'Oakenroar',e:'forest',r:'rare',pw:42,sp:20,wi:45,ch:25,hp:195,fl:['500 years old, still learning.','Invented multiplication tricks.','Math asks Oakenroar for tips.'],em:'üåø'},
{id:15,n:'Gaia Rootweaver',e:'forest',r:'ultra',pw:70,sp:40,wi:90,ch:50,hp:310,fl:['Grows forests as times tables.','The forest IS a times table.','Nature is math homework.'],em:'üå≥'},
{id:16,n:'Zapplet',e:'storm',r:'basic',pw:10,sp:16,wi:6,ch:9,hp:75,fl:['Looks permanently surprised.','The surprise is everyone else\'s.','Lightning crown of shock.'],em:'‚ö°'},
{id:17,n:'Thundernap',e:'storm',r:'medium',pw:24,sp:28,wi:15,ch:11,hp:110,fl:['Wakes up only for math puzzles.','Thunderstorms are the alarm.','Storms rage in sync with dreams.'],em:'‚ö°'},
{id:18,n:'Boltstrike',e:'storm',r:'rare',pw:44,sp:48,wi:30,ch:15,hp:165,fl:['Solves problems before you read them.','Solves before they\'re written.','Time bends around calculations.'],em:'‚ö°'},
{id:19,n:'Cyclonewing',e:'storm',r:'rare',pw:40,sp:50,wi:32,ch:20,hp:175,fl:['Tiny tornadoes sort numbers.','Tornadoes solve equations.','Weather includes math lessons.'],em:'‚ö°'},
{id:20,n:'Tempestrix',e:'storm',r:'ultra',pw:80,sp:88,wi:55,ch:30,hp:280,fl:['Lightning shaped like √∑ symbols.','Division symbols form in storms.','The sky is an infinite whiteboard.'],em:'üå©Ô∏è'},
{id:21,n:'Frostbite Jr.',e:'frost',r:'basic',pw:8,sp:10,wi:11,ch:14,hp:88,fl:['Invented dragon popsicles.','Sells popsicles now!','Popsicle empire spans the north.'],em:'‚ùÑÔ∏è'},
{id:22,n:'Sleetclaw',e:'frost',r:'medium',pw:22,sp:19,wi:22,ch:13,hp:118,fl:['Writes equations in frost.','Windows frost in equation patterns.','Every window is a frozen textbook.'],em:'‚ùÑÔ∏è'},
{id:23,n:'Glacierhorn',e:'frost',r:'medium',pw:26,sp:14,wi:28,ch:18,hp:130,fl:['Brain works like a supercomputer.','The supercomputer is quantum-cooled.','Absolute zero thinking temp.'],em:'‚ùÑÔ∏è'},
{id:24,n:'Blizzardmane',e:'frost',r:'rare',pw:46,sp:28,wi:42,ch:24,hp:185,fl:['Froze a math test for extra time.','Tests freeze on command.','Time freezes when it thinks.'],em:'‚ùÑÔ∏è'},
{id:25,n:'Arcticus',e:'frost',r:'ultra',pw:75,sp:45,wi:85,ch:45,hp:305,fl:['Ice palace with times tables.','The palace teaches itself.','Math crystallizes in its presence.'],em:'üèîÔ∏è'},
{id:26,n:'Gloomkit',e:'shadow',r:'basic',pw:9,sp:13,wi:10,ch:7,hp:82,fl:['Afraid of the dark ‚Äî ironic!','Conquered the fear.','Darkness is a cozy blanket.'],em:'üåë'},
{id:27,n:'Duskfang',e:'shadow',r:'medium',pw:25,sp:24,wi:18,ch:9,hp:122,fl:['Solves problems nobody asked for.','Solves before anyone knows.','Mysteries dissolve in shadow.'],em:'üåë'},
{id:28,n:'Voidwhisper',e:'shadow',r:'rare',pw:47,sp:38,wi:38,ch:14,hp:188,fl:['Whispers answers if you tried.','Whispers carry ancient truths.','Truth speaks in its voice.'],em:'üåë'},
{id:29,n:'Nightterror',e:'shadow',r:'rare',pw:52,sp:32,wi:44,ch:8,hp:205,fl:['Terrified of long division.','Conquered long division!','Long division trembles now.'],em:'üåë'},
{id:30,n:'Nyx the Eclipse',e:'shadow',r:'ultra',pw:82,sp:55,wi:75,ch:42,hp:295,fl:['Bends shadows into numbers.','Infinity is its favorite number.','Reality is math canvas.'],em:'üåí'}
];
const STRT=[1,6,11,16,21,26];
// Track A tiers
const TI=[
{n:'Hatchling',lv:[1,10],a:1,b:5,timer:15},{n:'Whelpling',lv:[11,20],a:2,b:8,timer:15},
{n:'Drake',lv:[21,30],a:3,b:12,timer:15},{n:'Wyrm',lv:[31,40],a:5,b:15,timer:15},
{n:'Elder Dragon',lv:[41,50],a:6,b:20,timer:12}
];
// Track B: TGATB levels (b1-b45)
const TB=[
// Grade K: Seedling Forest (b1-b15)
{n:'Number Recognition',lv:'b1',g:'K',focus:'count',timer:20},{n:'Counting to 10',lv:'b2',g:'K',focus:'count',timer:20},{n:'Comparing Numbers',lv:'b3',g:'K',focus:'count',timer:20},
{n:'Addition to 5 (1)',lv:'b4',g:'K',focus:'add5',timer:20},{n:'Addition to 5 (2)',lv:'b5',g:'K',focus:'add5',timer:20},{n:'Addition to 5 (3)',lv:'b6',g:'K',focus:'add5',timer:20},
{n:'Addition to 10 (1)',lv:'b7',g:'K',focus:'add10',timer:20},{n:'Making 10',lv:'b8',g:'K',focus:'add10',timer:20},{n:'Addition to 10 (3)',lv:'b9',g:'K',focus:'add10',timer:20},
{n:'Subtraction from 10 (1)',lv:'b10',g:'K',focus:'sub10',timer:20},{n:'Subtraction Missing',lv:'b11',g:'K',focus:'sub10',timer:20},{n:'Subtraction from 10 (3)',lv:'b12',g:'K',focus:'sub10',timer:20},
{n:'Mixed K Review (1)',lv:'b13',g:'K',focus:'mixK',timer:20},{n:'Odd & Even',lv:'b14',g:'K',focus:'mixK',timer:20},{n:'K Final Challenge',lv:'b15',g:'K',focus:'mixK',timer:20},
// Grade 1: Starlight Village (b16-b30)
{n:'Addition to 20 (1)',lv:'b16',g:'1',focus:'add20',timer:18},{n:'Addition to 20 (2)',lv:'b17',g:'1',focus:'add20',timer:18},{n:'Addition Missing',lv:'b18',g:'1',focus:'add20',timer:18},
{n:'Subtraction to 20 (1)',lv:'b19',g:'1',focus:'sub20',timer:18},{n:'Subtraction Missing',lv:'b20',g:'1',focus:'sub20',timer:18},{n:'Subtraction to 20 (3)',lv:'b21',g:'1',focus:'sub20',timer:18},
{n:'Skip Count by 2s',lv:'b22',g:'1',focus:'skip',timer:18},{n:'Skip Count by 5s',lv:'b23',g:'1',focus:'skip',timer:18},{n:'Skip Count by 10s',lv:'b24',g:'1',focus:'skip',timer:18},
{n:'Place Value Tens',lv:'b25',g:'1',focus:'place',timer:18},{n:'Comparing 2-digit',lv:'b26',g:'1',focus:'place',timer:18},{n:'Tens and Ones',lv:'b27',g:'1',focus:'place',timer:18},
{n:'Number Bonds',lv:'b28',g:'1',focus:'mix1',timer:18},{n:'Fact Families',lv:'b29',g:'1',focus:'mix1',timer:18},{n:'Grade 1 Final',lv:'b30',g:'1',focus:'mix1',timer:18},
// Grade 2: Mountain Kingdom (b31-b45)
{n:'Add within 100 (1)',lv:'b31',g:'2',focus:'add100',timer:15},{n:'Add within 100 (2)',lv:'b32',g:'2',focus:'add100',timer:15},{n:'Add Missing',lv:'b33',g:'2',focus:'add100',timer:15},
{n:'Sub within 100 (1)',lv:'b34',g:'2',focus:'sub100',timer:15},{n:'Sub within 100 (2)',lv:'b35',g:'2',focus:'sub100',timer:15},{n:'Sub Missing',lv:'b36',g:'2',focus:'sub100',timer:15},
{n:'Intro Multiply (1)',lv:'b37',g:'2',focus:'mult2',timer:15},{n:'Multiply by 2-5',lv:'b38',g:'2',focus:'mult2',timer:15},{n:'Arrays',lv:'b39',g:'2',focus:'mult2',timer:15},
{n:'Coin Values',lv:'b40',g:'2',focus:'money',timer:15},{n:'Adding Coins',lv:'b41',g:'2',focus:'money',timer:15},{n:'Time',lv:'b42',g:'2',focus:'money',timer:15},
{n:'Mixed Mastery (1)',lv:'b43',g:'2',focus:'mix2',timer:15},{n:'Mixed Mastery (2)',lv:'b44',g:'2',focus:'mix2',timer:15},{n:'Grade 2 Final',lv:'b45',g:'2',focus:'mix2',timer:15}
];
const TB_GRADES=[
{id:'K',n:'üå± Seedling Forest',sub:'Grade K: Numbers & Basics',c:'#2ECC71',lvs:['b1','b2','b3','b4','b5','b6','b7','b8','b9','b10','b11','b12','b13','b14','b15']},
{id:'1',n:'üåü Starlight Village',sub:'Grade 1: Add/Sub to 20',c:'#3498DB',lvs:['b16','b17','b18','b19','b20','b21','b22','b23','b24','b25','b26','b27','b28','b29','b30']},
{id:'2',n:'üèîÔ∏è Mountain Kingdom',sub:'Grade 2: Within 100 & More',c:'#F39C12',lvs:['b31','b32','b33','b34','b35','b36','b37','b38','b39','b40','b41','b42','b43','b44','b45']}
];
// Bosses
const BOSSES=[
{id:'B1',n:'Grimjaw the Unyielding',e:'flame',hp:250,pw:48,sp:30,ab:'rage',abt:'Below 40% HP: 2√ó damage',fl:"Hasn't had coffee in 300 years.",rw:{f:30,r:15}},
{id:'B2',n:'Empress Coralith',e:'tide',hp:280,pw:38,sp:45,ab:'tidal',abt:'Every 4th turn: numbers reversed',fl:'Crown of calculator buttons.',rw:{f:50,r:25}},
{id:'B3',n:'Thornmother Sylvara',e:'forest',hp:320,pw:35,sp:25,ab:'regrow',abt:'Every 3rd turn: heals 15%',fl:'Remembers when √ó was invented.',rw:{f:70,r:35}},
{id:'B4',n:'General Voltstorm',e:'storm',hp:260,pw:55,sp:60,ab:'static',abt:'>8 sec = bonus zap damage',fl:'Times everything with lightning.',rw:{f:90,r:45}},
{id:'B5',n:'The Frozen Arbiter',e:'frost',hp:300,pw:42,sp:35,ab:'freeze',abt:'Every 3rd turn: freeze power',fl:'Terrifyingly good at division.',rw:{f:120,r:60}},
{id:'B6',n:"Nyx'Rath the Void King",e:'shadow',hp:350,pw:58,sp:50,ab:'veil',abt:'30% dodge, 50% below 30%',fl:'Nobody knows the mask.',rw:{f:200,r:80}}
];
// Arena tiers
const AT=[
{id:'hatchling',n:'Hatchling Pit',ic:'ü•â',ul:5,cost:50,df:1,ehp:[60,100],epw:[8,15]},
{id:'drake',n:'Drake Coliseum',ic:'ü•à',ul:15,cost:150,df:2,ehp:[100,160],epw:[18,30]},
{id:'wyrm',n:'Wyrm Wargrounds',ic:'ü•á',ul:25,cost:300,df:3,ehp:[150,220],epw:[28,45]},
{id:'elder',n:'Elder Sanctum',ic:'üíé',ul:40,cost:500,df:4,ehp:[200,300],epw:[40,60],boss:true}
];
const IT={healing_potion:{n:'Healing Potion',ic:'üß™',cost:5,d:'Restores 30% HP'},iron_shield:{n:'Iron Shield',ic:'üõ°Ô∏è',cost:8,d:'50% reduction 2t'},speed_scroll:{n:'Speed Scroll',ic:'‚ö°',cost:6,d:'First strike 3t'},focus_gem:{n:'Focus Gem',ic:'üéØ',cost:10,d:'Auto-correct 1'}};
const AR=[{l:0,cost:0,hp:0,dr:0},{l:1,cost:10,hp:10,dr:.02},{l:2,cost:15,hp:20,dr:.04},{l:3,cost:20,hp:30,dr:.06},{l:4,cost:25,hp:40,dr:.08},{l:5,cost:30,hp:50,dr:.10}];
const TR=[{id:1,i:'üå±',n:'First Sprout',d:'Complete first level'},{id:2,i:'‚úñÔ∏è',n:'Mult Rookie',d:'10 mult correct'},{id:3,i:'‚ûó',n:'Div Rookie',d:'10 div correct'},{id:4,i:'‚ûï',n:'Addition Ace',d:'25 addition correct'},{id:5,i:'‚ûñ',n:'Subtraction Star',d:'25 subtraction correct'},{id:6,i:'üî•',n:'On Fire!',d:'5 in a row'},{id:7,i:'‚≠ê',n:'Perfectionist',d:'10/10 on any level'},{id:8,i:'üíØ',n:'Century Club',d:'100 total correct'},{id:9,i:'üêâ',n:'Dragon Tamer',d:'Buy first dragon'},{id:10,i:'‚ú®',n:'Awakening',d:'Evolve to Stage 2'},{id:11,i:'üåü',n:'Ascension',d:'Evolve to Stage 3'},{id:12,i:'üõ°Ô∏è',n:'Armor Up!',d:'Buy first armor'},{id:13,i:'üè∞',n:'Fully Fortified',d:'Max armor'},{id:14,i:'üìÖ',n:'Dedicated',d:'7-day streak'},{id:15,i:'üéØ',n:'Sharpshooter',d:'5 perfect levels'},{id:16,i:'üß†',n:'Big Brain',d:'Complete A 1-10'},{id:17,i:'‚öîÔ∏è',n:'Whelp Warrior',d:'Complete A 11-20'},{id:18,i:'üê≤',n:'Drake Destroyer',d:'Complete A 21-30'},{id:19,i:'üå™Ô∏è',n:'Wyrm Wrangler',d:'Complete A 31-40'},{id:20,i:'üëë',n:'Elder Champion',d:'Complete A 41-50'},{id:21,i:'üå±',n:'Seedling Graduate',d:'Complete B Grade K'},{id:22,i:'üåü',n:'Starlight Scholar',d:'Complete B Grade 1'},{id:23,i:'üèîÔ∏è',n:'Mountain Master',d:'Complete B Grade 2'},{id:24,i:'‚öîÔ∏è',n:'Arena Debut',d:'Win first battle'},{id:25,i:'üíÄ',n:'Boss Slayer',d:'Defeat any boss'},{id:26,i:'üåë',n:'Void Conqueror',d:"Defeat Nyx'Rath"},{id:27,i:'üèÖ',n:'Arena Champ',d:'Score 2000+'},{id:28,i:'ü§ù',n:'Friendly Rival',d:'Win multiplayer'},{id:29,i:'üëä',n:'Clash Champ',d:'Win 10 clashes'},{id:30,i:'üì¨',n:'Pen Pal',d:'Win via code'},{id:32,i:'üèÖ',n:'Math Legend',d:'Earn all trophies'}];
const TAUNTS=["My dragon had extra breakfast! üç≥","Hope you studied! üìö","Here comes a fireball! üî•","Your dragon looks sleepy... üò¥","Math power ACTIVATE! ‚ö°","Cute dragon! üê£","Better bring a calculator! üßÆ","3... 2... 1... BLAST! üí•","Good luck! üçÄ","My dragon eats √∑ for breakfast! ü•û"];
// Helpers
function gd(id){return DR.find(d=>d.id===id);}
function gt(lv){return TI.find(t=>lv>=t.lv[0]&&lv<=t.lv[1]);}
function gr(xp){let r=RANKS[0];for(const x of RANKS)if(xp>=x.t)r=x;return r;}
function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function getBoss(id){return BOSSES.find(b=>b.id===id);}
function getTBLevel(lv){return TB.find(t=>t.lv===lv);}
// === STORAGE (upgraded for Phase 2) ===
const S={KEY:'dm4',_p:null,
ld(){try{return JSON.parse(localStorage.getItem(this.KEY))||null}catch(e){return null}},
sv(d){try{localStorage.setItem(this.KEY,JSON.stringify(d))}catch(e){}},
dt(){let d=this.ld();if(!d)d={pin:null,pr:{}};return d},
prs(){return this.dt().pr},pc(){return Object.keys(this.prs()).length},
cr(nm,age){const d=this.dt(),id='p'+Date.now();d.pr[id]=this.fr(nm,age);this.sv(d);return id},
fr(nm,age){return{pl:{nm,age,ll:null,sk:0,ob:false},xp:0,xs:0,co:0,tc:0,st:{c:0,a:0,mc:0,dc:0,bs:0,cs:0,pl:0,ac:0,sc:0,bc:0,bw:0,mw:0},lv:{},blv:{},dg:{ow:[],sg:{},wi:{},ar:{},fr:{},ac:null},an:{w:0,l:0,it:{healing_potion:0,iron_shield:0,speed_scroll:0,focus_gem:0},bk:{}},mp:{w:0,l:0,codes:{}},tp:[],wk:{id:null,p:0},potd:{d:null,dn:false},set:{snd:true}}},
dl(id){const d=this.dt();delete d.pr[id];this.sv(d)},
sa(id){this._p=id;sessionStorage.setItem('ap',id||'')},
gi(){if(this._p)return this._p;this._p=sessionStorage.getItem('ap')||null;return this._p},
pf(){const id=this.gi();if(!id)return null;const d=this.dt();let p=d.pr[id]||null;if(p&&!p.blv)p.blv={};if(p&&!p.mp)p.mp={w:0,l:0,codes:{}};if(p&&!p.wk)p.wk={id:null,p:0};if(p&&!p.potd)p.potd={d:null,dn:false};if(p&&!p.st.ac)p.st.ac=0;if(p&&!p.st.sc)p.st.sc=0;if(p&&!p.st.bc)p.st.bc=0;if(p&&!p.st.bw)p.st.bw=0;if(p&&!p.st.mw)p.st.mw=0;if(p&&!p.an.bk)p.an.bk={};return p},
sp(p){const id=this.gi();if(!id)return;const d=this.dt();d.pr[id]=p;this.sv(d)},
ac(n){const p=this.pf();p.co+=n;p.tc+=n;this.sp(p)},
sc(n){const p=this.pf();if(p.co<n)return false;p.co-=n;this.sp(p);return true},
ax(n){const p=this.pf();p.xp+=n;p.xs+=n;this.sp(p)},
sx(n){const p=this.pf();if(p.xs<n)return false;p.xs-=n;this.sp(p);return true},
cd(){const p=this.pf();if(!p)return null;const t=new Date().toISOString().split('T')[0];if(p.pl.ll===t)return{nw:false};const y=new Date(Date.now()-864e5).toISOString().split('T')[0];p.pl.sk=p.pl.ll===y?p.pl.sk+1:1;p.pl.ll=t;this.sp(p);let bc=10;if(p.pl.sk>=14)bc+=30;else if(p.pl.sk>=7)bc+=15;else if(p.pl.sk>=3)bc+=5;this.ac(bc);this.ax(25);return{nw:true,sk:p.pl.sk,bc,bx:25}},
pin(){return this.dt().pin},sp2(v){const d=this.dt();d.pin=v;this.sv(d)},vp(v){return this.pin()===v},
ut(tid){const p=this.pf();if(!p||p.tp.includes(tid))return false;p.tp.push(tid);this.sp(p);return true},
sl(lv,sc){const p=this.pf();const k=typeof lv==='string'?lv:lv;const store=typeof lv==='string'&&lv.startsWith('b')?'blv':'lv';const x=p[store][k]||{s:0,b:0,a:0};const st=sc>=9?3:sc>=5?2:sc>=1?1:0;x.a++;if(sc>x.b)x.b=sc;if(st>x.s)x.s=st;p[store][k]=x;this.sp(p)},
hl(){const p=this.pf();if(!p)return 0;let h=0;for(const[k,v]of Object.entries(p.lv))if(v.s>0&&+k>h)h=+k;return h},
hlb(grade){const p=this.pf();if(!p)return 0;const g=TB_GRADES.find(x=>x.id===grade);if(!g)return 0;let h=0;for(let i=0;i<g.lvs.length;i++){const lv=g.lvs[i];if(p.blv[lv]&&p.blv[lv].s>0)h=i+1;else break}return h},
od(id){const p=this.pf();if(p.dg.ow.includes(id))return;p.dg.ow.push(id);p.dg.sg[id]=1;p.dg.wi[id]=0;p.dg.ar[id]=0;p.dg.fr[id]=0;if(!p.dg.ac)p.dg.ac=id;this.sp(p)},
ds(id){const p=this.pf();if(!p)return null;const b=gd(id);if(!b)return null;const st=p.dg.sg[id]||1,al=p.dg.ar[id]||0,arm=AR[al];let m=st===2?1.25:st===3?1.5:1,hm=st===2?1.2:st===3?1.4:1;return{...b,stage:st,alv:al,power:Math.floor(b.pw*m),speed:Math.floor(b.sp*m),wisdom:Math.floor(b.wi*m),charm:Math.floor(b.ch*m),hp:Math.floor(b.hp*hm)+arm.hp,mhp:Math.floor(b.hp*hm)+arm.hp,dr:arm.dr,dn:b.n+(st===2?' ‚ú¶':st===3?' ‚ú¶‚ú¶':''),fv:b.fl[st-1],fr:p.dg.fr[id]||0,ws:p.dg.wi[id]||0}}
};
// === AUDIO ===
const A={x:null,m:false,
init(){try{this.x=new(window.AudioContext||window.webkitAudioContext)()}catch(e){}},
en(){if(!this.x)this.init();if(this.x&&this.x.state==='suspended')this.x.resume()},
tg(){this.m=!this.m;document.getElementById('mb').textContent=this.m?'üîá':'üîä'},
o(f,t,d,g){if(this.m||!this.x)return;this.en();try{const o=this.x.createOscillator(),gn=this.x.createGain();o.type=t;o.frequency.value=f;gn.gain.setValueAtTime(g||.12,this.x.currentTime);gn.gain.exponentialRampToValueAtTime(.001,this.x.currentTime+d);o.connect(gn);gn.connect(this.x.destination);o.start();o.stop(this.x.currentTime+d)}catch(e){}},
p(t){if(this.m)return;this.en();try{
if(t==='ok')[523,659,784].forEach((f,i)=>setTimeout(()=>this.o(f,'sine',.2),i*60));
else if(t==='no'){this.o(200,'sine',.3,.1);setTimeout(()=>this.o(160,'sine',.3,.1),100)}
else if(t==='done')[523,587,659,784,880,1047].forEach((f,i)=>setTimeout(()=>this.o(f,'sine',.25,.1),i*80));
else if(t==='cl')this.o(800,'sine',.05,.08);
else if(t==='cn'){this.o(1200,'sine',.08);setTimeout(()=>this.o(1600,'sine',.1,.06),50)}
else if(t==='rr'){this.o(100,'sawtooth',.5,.15);this.o(80,'sawtooth',.6,.1)}
else if(t==='at'){this.o(300,'sawtooth',.15);setTimeout(()=>this.o(600,'square',.1,.08),50)}
else if(t==='ht'){this.o(150,'square',.1,.15);this.o(80,'sawtooth',.15,.1)}
else if(t==='pw')[400,600,800,1000,1200].forEach((f,i)=>setTimeout(()=>this.o(f,'sine',.15,.1),i*50));
else if(t==='vc')[523,659,784,1047,784,1047].forEach((f,i)=>setTimeout(()=>this.o(f,'sine',.3,.12),i*120));
else if(t==='df')[400,350,300,250].forEach((f,i)=>setTimeout(()=>this.o(f,'sine',.3,.1),i*150));
else if(t==='tr')[523,659,784,1047].forEach((f,i)=>setTimeout(()=>this.o(f,'triangle',.35,.12),i*100));
else if(t==='boss')[80,100,120,100,80,60].forEach((f,i)=>setTimeout(()=>this.o(f,'sawtooth',.4,.2),i*150));
else if(t==='clash')[523,784,1047,784,523].forEach((f,i)=>setTimeout(()=>this.o(f,'square',.15,.12),i*80));
}catch(e){}}
};
// === MATH ENGINE (Phase 1 + Track B) ===
function gp(lv){const t=gt(lv);if(!t)return{d:'1√ó1=?',an:1,tp:'m',tm:15};const ti=TI.indexOf(t);
let tp=Math.random()<.55?'m':'d';if(ti>=3&&Math.random()<.25)tp='mf';if(ti>=4&&Math.random()<.25)tp='ms';
if(tp==='m'){const a=ri(t.a,t.b),b=ri(t.a,t.b);return{d:`${a} √ó ${b} = ?`,an:a*b,tp:'m',tm:t.timer}}
if(tp==='d'){const dv=ri(t.a,t.b),q=ri(t.a,t.b);return{d:`${dv*q} √∑ ${dv} = ?`,an:q,tp:'d',tm:t.timer}}
if(tp==='mf'){const a=ri(t.a,t.b),b=ri(t.a,t.b),p=a*b;return Math.random()<.5?{d:`? √ó ${b} = ${p}`,an:a,tp:'m',tm:t.timer}:{d:`${a} √ó ? = ${p}`,an:b,tp:'m',tm:t.timer}}
const a=ri(2,10),b=ri(2,8),pr=a*b;const ds=[];for(let d=2;d<=Math.min(pr,12);d++)if(pr%d===0)ds.push(d);
if(!ds.length)return{d:`${a}√ó${b}=?`,an:pr,tp:'m',tm:t.timer};const dv=ds[ri(0,ds.length-1)];
return{d:`${a} √ó ${b} √∑ ${dv} = ?`,an:pr/dv,tp:'m',tm:t.timer+3}}

// Track B problem generator
function gpb(lvId){const tbl=getTBLevel(lvId);if(!tbl)return{d:'1+1=?',an:2,tp:'a',tm:20,mc:null};
const f=tbl.focus,tm=tbl.timer;
if(f==='count'){const n=ri(1,20);const ops=['count','recognize','compare'];const op=ops[ri(0,2)];
if(op==='count'){const c=ri(1,10);const emoji='üçé';return{d:`Count: ${emoji.repeat(c)}`,an:c,tp:'a',tm,mc:null}}
if(op==='recognize')return{d:`What number comes after ${n}?`,an:n+1,tp:'a',tm,mc:null};
const a=ri(1,15),b=ri(1,15);while(a===b){return gpb(lvId)}
return{d:`Which is bigger: ${a} or ${b}?`,an:Math.max(a,b),tp:'a',tm,mc:[a,b,Math.max(a,b),Math.min(a,b)]}}
if(f==='add5'){const a=ri(0,5),b=ri(0,5-a);return{d:`${a} + ${b} = ?`,an:a+b,tp:'a',tm,mc:null}}
if(f==='add10'){const a=ri(1,9),b=ri(1,10-a);return{d:`${a} + ${b} = ?`,an:a+b,tp:'a',tm,mc:null}}
if(f==='sub10'){const t2=ri(2,10),b=ri(1,t2);if(Math.random()<.3)return{d:`${t2} ‚àí ? = ${t2-b}`,an:b,tp:'s',tm,mc:null};return{d:`${t2} ‚àí ${b} = ?`,an:t2-b,tp:'s',tm,mc:null}}
if(f==='mixK'){const ops=['add10','sub10'];return gpb_focus(ops[ri(0,1)],tm)}
if(f==='add20'){const a=ri(1,19),b=ri(1,20-a);if(Math.random()<.25)return{d:`? + ${b} = ${a+b}`,an:a,tp:'a',tm,mc:null};return{d:`${a} + ${b} = ?`,an:a+b,tp:'a',tm,mc:null}}
if(f==='sub20'){const t2=ri(2,20),b=ri(1,t2);if(Math.random()<.25)return{d:`${t2} ‚àí ? = ${t2-b}`,an:b,tp:'s',tm,mc:null};return{d:`${t2} ‚àí ${b} = ?`,an:t2-b,tp:'s',tm,mc:null}}
if(f==='skip'){const by=[2,5,10][ri(0,2)],start=ri(0,5)*by,seq=start+by;return{d:`Skip count by ${by}: ${start}, ${seq}, ?`,an:seq+by,tp:'a',tm,mc:null}}
if(f==='place'){const tens=ri(1,9),ones=ri(0,9),n=tens*10+ones;if(Math.random()<.5)return{d:`How many tens in ${n}?`,an:tens,tp:'a',tm,mc:null};return{d:`${tens} tens and ${ones} ones = ?`,an:n,tp:'a',tm,mc:null}}
if(f==='mix1'){const ops=['add20','sub20','skip','place'];return gpb_focus(ops[ri(0,3)],tm)}
if(f==='add100'){const a=ri(10,90),b=ri(5,100-a);if(Math.random()<.2)return{d:`? + ${b} = ${a+b}`,an:a,tp:'a',tm,mc:null};return{d:`${a} + ${b} = ?`,an:a+b,tp:'a',tm,mc:null}}
if(f==='sub100'){const t2=ri(20,100),b=ri(5,t2);if(Math.random()<.2)return{d:`${t2} ‚àí ? = ${t2-b}`,an:b,tp:'s',tm,mc:null};return{d:`${t2} ‚àí ${b} = ?`,an:t2-b,tp:'s',tm,mc:null}}
if(f==='mult2'){const a=ri(2,5),b=ri(1,10);return{d:`${a} √ó ${b} = ?`,an:a*b,tp:'m',tm,mc:null}}
if(f==='money'){const coins=[1,5,10,25];const c1=coins[ri(0,3)],c2=coins[ri(0,3)];return{d:`${c1}¬¢ + ${c2}¬¢ = ?¬¢`,an:c1+c2,tp:'a',tm,mc:null}}
if(f==='mix2'){const ops=['add100','sub100','mult2','money'];return gpb_focus(ops[ri(0,3)],tm)}
return{d:'1+1=?',an:2,tp:'a',tm:20,mc:null}}
function gpb_focus(f,tm){const fake={focus:f,timer:tm,lv:'temp',g:'K',n:'temp'};const orig=getTBLevel;getTBLevel=()=>fake;const r=gpb('temp');getTBLevel=orig;return r}
// === FX ===
function sb(x,y){const b=document.createElement('div');b.className='sbw';b.style.left=x+'px';b.style.top=y+'px';['‚≠ê','‚ú®','üåü','üí´','‚≠ê','‚ú®','üåü','üí´'].forEach((s,i)=>{const p=document.createElement('span');p.className='sp';p.textContent=s;const a=(i/8)*Math.PI*2,d=40+Math.random()*30;p.style.setProperty('--tx',Math.cos(a)*d+'px');p.style.setProperty('--ty',Math.sin(a)*d+'px');b.appendChild(p)});document.body.appendChild(b);setTimeout(()=>b.remove(),1000)}
function cf(){const c=document.createElement('div');c.className='cfw';const cl=['#F5C542','#E74C3C','#2ECC71','#3498DB','#9B59B6','#FF6B35'];for(let i=0;i<35;i++){const p=document.createElement('div');p.className='cfp';p.style.left=Math.random()*100+'%';p.style.background=cl[ri(0,5)];p.style.setProperty('--dur',(1.5+Math.random()*2)+'s');p.style.setProperty('--rot',(Math.random()*720)+'deg');p.style.animationDelay=Math.random()*.5+'s';p.style.borderRadius=Math.random()>.5?'50%':'2px';p.style.width=(6+Math.random()*8)+'px';p.style.height=(6+Math.random()*8)+'px';c.appendChild(p)}document.body.appendChild(c);setTimeout(()=>c.remove(),4000)}
function md(title,body,btns){document.querySelectorAll('.mo').forEach(m=>m.remove());const o=document.createElement('div');o.className='mo';o.innerHTML=`<div class="mc"><h2>${title}</h2><div style="margin:14px 0">${body}</div><div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">${btns.map((b,i)=>`<button class="btn ${b.c||'bp'}" data-mi="${i}">${b.l}</button>`).join('')}</div></div>`;document.body.appendChild(o);o.addEventListener('click',e=>{if(e.target===o)o.remove()});o.querySelectorAll('[data-mi]').forEach((el,i)=>el.addEventListener('click',()=>{o.remove();if(btns[i].f)btns[i].f()}))}
function np(){return'<div class="np-grid">'+[1,2,3,4,5,6,7,8,9].map(n=>`<button class="npb" data-n="${n}">${n}</button>`).join('')+`<button class="npb nb2" data-n="back">‚å´</button><button class="npb" data-n="0">0</button><button class="npb ne" data-n="enter">‚úì</button></div>`}
function tt(tid){if(S.ut(tid)){const t=TR.find(x=>x.id===tid);if(t){A.p('tr');setTimeout(()=>md('üèÜ Trophy!',`<div style="font-size:3rem">${t.i}</div><div style="font-family:var(--fd);color:var(--gold);margin-top:8px">${t.n}</div><div style="font-size:.85rem;opacity:.8">${t.d}</div>`,[{l:'Awesome!'}]),500)}}}
function an(el,tgt,dur){dur=dur||800;const st=performance.now();const tk=now=>{const p=Math.min((now-st)/dur,1);el.textContent=Math.floor(p*tgt);if(p<1)requestAnimationFrame(tk);else el.textContent=tgt};requestAnimationFrame(tk)}
// === GLOBALS ===
const $=id=>document.getElementById(id);const sc=()=>$('scr');
let nph=null,tmr=null;
document.addEventListener('click',e=>{const b=e.target.closest('[data-n]');if(b&&nph)nph(b.dataset.n)});
document.addEventListener('keydown',e=>{if(!nph)return;if(e.key>='0'&&e.key<='9'){e.preventDefault();nph(e.key)}else if(e.key==='Backspace'){e.preventDefault();nph('back')}else if(e.key==='Enter'){e.preventDefault();nph('enter')}});
function showC(){$('top-bar').classList.remove('hidden');$('bnav').classList.remove('hidden')}
function hideC(){$('top-bar').classList.add('hidden');$('bnav').classList.add('hidden')}
function ub(){const p=S.pf();if(!p)return;$('pnd').textContent=p.pl.nm;$('rb').textContent=gr(p.xp).title;$('xa').textContent=p.xs;$('ca').textContent=p.co}
// === PROFILES ===
function showPr(){hideC();nph=null;const pr=S.prs(),ids=Object.keys(pr),av=['üêâ','üê≤','üî•','‚ö°','‚ùÑÔ∏è','üåä','üåø','üåë'];let h='';
ids.forEach((id,i)=>{const p=pr[id];h+=`<div class="pc" data-pid="${id}"><span class="av">${av[i%8]}</span><div class="pn">${esc(p.pl.nm)}</div><div class="li">${gr(p.xp).title} ¬∑ ‚ö°${p.xp} ¬∑ ü™ô${p.co}</div></div>`});
if(ids.length<4)h+=`<div class="pc np" id="newp"><span class="av" style="opacity:.5">‚ûï</span><div class="pn" style="color:var(--purple-p)">New Adventurer</div></div>`;
sc().innerHTML=`<div class="ob" style="min-height:auto;padding-top:30px"><div class="ms">üêâ</div><h1>Dragon Math Academy</h1><p>Choose your adventurer!</p><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;width:100%;max-width:380px">${h}</div></div>`;
sc().querySelectorAll('[data-pid]').forEach(el=>el.addEventListener('click',()=>{A.p('cl');S.sa(el.dataset.pid);const p=S.pf();if(p&&p.pl.ob)enterApp();else startOB()}));
const nb=$('newp');if(nb)nb.addEventListener('click',startOB)}
// === ONBOARD ===
let ob={s:0,nm:'',ag:9,dg:null};
function startOB(){if(S.pc()===0&&!S.pin()){hideC();sc().innerHTML=`<div class="ob"><div class="ms">üîí</div><h1>Parent Setup</h1><p>Set a 4-digit PIN to protect profiles.</p><input type="password" class="inf" id="pi" maxlength="4" placeholder="4-digit PIN" style="max-width:200px;text-align:center;font-size:1.5rem;letter-spacing:8px" inputmode="numeric"><div class="mt16"><button class="btn bp" id="ps">Set PIN</button></div></div>`;$('ps').addEventListener('click',()=>{const v=$('pi').value;if(!/^\d{4}$/.test(v)){md('Oops!','Enter exactly 4 numbers.',[{l:'OK'}]);return}S.sp2(v);ob={s:0,nm:'',ag:9,dg:null};rOB()});setTimeout(()=>$('pi').focus(),100);return}ob={s:0,nm:'',ag:9,dg:null};rOB()}
function rOB(){hideC();if(ob.s===0)ob0();else if(ob.s===1)ob1();else if(ob.s===2)ob2();else if(ob.s===3)ob3();else if(ob.s===4)ob4();else ob5()}
function ob0(){sc().innerHTML=`<div class="ob"><div class="ms">üêâ</div><h1>Welcome to Dragon Math Academy!</h1><p>Solve math, collect dragons, and battle!</p><button class="btn bp blg" id="g0">Start Your Adventure! üöÄ</button></div>`;$('g0').addEventListener('click',()=>{ob.s=1;rOB()})}
function ob1(){sc().innerHTML=`<div class="ob"><div class="ms">‚úèÔ∏è</div><h1>What's your name?</h1><input type="text" class="inf" id="ni" maxlength="20" placeholder="Your name" style="max-width:280px;text-align:center" autocomplete="off"><div class="mt16"><button class="btn bp" id="g1">Next ‚Üí</button></div></div>`;$('g1').addEventListener('click',()=>{const n=($('ni').value||'').trim();if(n.length<2||!/^[a-zA-Z0-9 ]+$/.test(n)){md('Oops!','2‚Äì20 chars, letters/numbers/spaces.',[{l:'OK'}]);return}ob.nm=n;ob.s=2;rOB()});setTimeout(()=>$('ni').focus(),100)}
function ob2(){sc().innerHTML=`<div class="ob"><div class="ms">üéÇ</div><h1>How old are you?</h1><p>Helps pick difficulty!</p><div class="ab">${[5,6,7,8,9,10,11].map(a=>`<button class="abtn${ob.ag===a?' sel':''}" data-a="${a}">${a}</button>`).join('')}</div><div class="mt16"><button class="btn bp" id="g2">Next ‚Üí</button></div></div>`;sc().querySelectorAll('[data-a]').forEach(b=>b.addEventListener('click',()=>{ob.ag=+b.dataset.a;A.p('cl');sc().querySelectorAll('.abtn').forEach(x=>x.classList.remove('sel'));b.classList.add('sel')}));$('g2').addEventListener('click',()=>{ob.s=3;rOB()})}
function ob3(){const sts=STRT.map(id=>gd(id));let info=ob.dg?`<div class="card mt12" style="max-width:280px;text-align:left">${(()=>{const d=gd(ob.dg),el=EL[d.e];return`<div style="font-family:var(--fd);color:var(--gold);margin-bottom:4px">${d.n} ${el.i}</div><div style="font-size:.82rem;opacity:.8;margin-bottom:6px">${d.fl[0]}</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;font-size:.78rem"><span>‚öîÔ∏è${d.pw}</span><span>üí®${d.sp}</span><span>üß†${d.wi}</span><span>üíñ${d.ch}</span><span>‚ù§Ô∏è${d.hp}</span><span>‚ú®${el.pw}</span></div>`})()}</div>`:'<p style="opacity:.5;margin-top:12px">Tap a dragon!</p>';
sc().innerHTML=`<div class="ob" style="min-height:auto"><div class="ms">ü•ö</div><h1>Choose Your Dragon!</h1><div class="dcar">${sts.map(d=>{const el=EL[d.e];return`<div class="dc rb${ob.dg===d.id?' sel':''}" data-d="${d.id}"><span class="de">${d.em}</span><div class="dn">${d.n}</div><div class="dl">${el.i} ${el.n}</div></div>`}).join('')}</div>${info}<div class="mt16"><button class="btn bp" id="g3" ${!ob.dg?'disabled':''}>Choose ‚Üí</button></div></div>`;
sc().querySelectorAll('[data-d]').forEach(c=>c.addEventListener('click',()=>{ob.dg=+c.dataset.d;A.p('cl');ob3()}));const b=$('g3');if(b)b.addEventListener('click',()=>{if(ob.dg){ob.s=4;rOB()}})}
// Tutorial
let tu={c:0,ok:0,pr:null,dn:false};
function ob4(){if(!tu.pr)tu={c:0,ok:0,dn:false,pr:[{d:'2 √ó 3 = ?',an:6},{d:'4 √ó 2 = ?',an:8},{d:'10 √∑ 2 = ?',an:5}]};
if(tu.c>=3){ob.s=5;rOB();return}
const pb=tu.pr[tu.c],tips=['üí° Solve problems to earn XP and coins!','üí° Correct = power for your dragon!','üí° You\'re doing great!'];
sc().innerHTML=`<div class="tc2" style="padding:16px"><div style="font-size:.82rem;color:var(--gold);margin-bottom:6px">Tutorial (${tu.c+1}/3)</div><div style="background:rgba(245,197,66,.1);border:1px solid rgba(245,197,66,.3);border-radius:12px;padding:10px;margin-bottom:14px;font-size:.82rem">${tips[tu.c]}</div><div style="font-family:var(--fd);font-size:2.4rem;margin:20px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px"></div><div class="mt12">${np()}</div></div>`;
tu.dn=false;nph=v=>{if(tu.dn)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u))return;tu.dn=true;if(u===tu.pr[tu.c].an){tu.ok++;A.p('ok');sb(innerWidth/2,innerHeight/3)}else A.p('no');setTimeout(()=>{tu.c++;ob4()},1000);return}if(b.textContent.length<5){b.textContent+=v;A.p('cl')}}}
function ob5(){nph=null;let pid=S.gi();if(!pid)pid=S.cr(ob.nm,ob.ag);S.sa(pid);S.od(ob.dg);const p=S.pf();p.dg.ac=ob.dg;p.pl.ob=true;p.pl.nm=ob.nm;p.pl.ag=ob.ag;S.sp(p);tu={c:0,ok:0,pr:null,dn:false};A.p('rr');cf();const d=gd(ob.dg);
sc().innerHTML=`<div class="ob"><div class="ms">${d.em}</div><h1>You're Ready!</h1><p><strong>${d.n}</strong> joined your team!<br>Solve math, collect dragons, battle!</p><div class="card" style="margin:14px 0;padding:14px;text-align:center;font-size:.75rem;color:var(--purple-p)">üîí Arena at Level 5!</div><button class="btn bp blg" id="gm">Let's Go! üêâ</button></div>`;
$('gm').addEventListener('click',enterApp)}
// === MAIN ===
let ct='play';
function enterApp(){const p=S.pf();if(!p)return showPr();A.m=!p.set.snd;$('mb').textContent=A.m?'üîá':'üîä';showC();ub();swt('play')}
function swt(t){ct=t;nph=null;if(tmr)clearInterval(tmr);document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('act',b.dataset.t===t));if(t==='play')showH();else if(t==='arena')showAr();else if(t==='dragons')showDr();else if(t==='trophies')showTr();else if(t==='settings')showSt();ub()}
document.querySelectorAll('.nb').forEach(b=>b.addEventListener('click',()=>{A.p('cl');swt(b.dataset.t)}));
$('mb').addEventListener('click',()=>{A.en();A.tg();const p=S.pf();if(p){p.set.snd=!A.m;S.sp(p)}});
// === HOME (Phase 2 - Track B + POTD + Weekly) ===
function showH(){const p=S.pf();if(!p)return showPr();const h=S.hl(),nx=Math.min(h+1,50),dl=S.cd();
let db='';if(dl&&dl.nw)db=`<div class="card cg mb12 tc2" style="animation:bi .5s"><div style="font-size:1.4rem">üìÖ</div><div style="font-family:var(--fd);color:var(--gold)">Daily Bonus!</div><div style="font-size:.82rem">+${dl.bc}ü™ô +${dl.bx}‚ö° Streak:${dl.sk}d</div></div>`;
// POTD card
const today=new Date().toISOString().split('T')[0];
let potdHtml='';
if(!p.potd||p.potd.d!==today){
potdHtml=`<div class="potd-card" id="potdBtn"><div style="font-size:1.4rem">üß©</div><div style="font-family:var(--fd);color:var(--gold);font-size:.9rem">Problem of the Day!</div><div style="font-size:.78rem;opacity:.7">Earn bonus coins!</div></div>`}
else if(p.potd.dn){potdHtml=`<div class="potd-card" style="opacity:.5;cursor:default"><div style="font-size:1.2rem">‚úÖ</div><div style="font-size:.8rem;opacity:.7">POTD Complete!</div></div>`}
// Weekly challenge
const wk=getWeekly();
let wkHtml='';
if(wk){const prog=p.wk&&p.wk.id===wk.id?p.wk.p:0;const done=prog>=wk.goal;
wkHtml=`<div class="weekly-card" id="wkBtn" style="cursor:pointer"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-family:var(--fd);font-size:.85rem;color:var(--gold)">üìã Weekly Challenge</div><div style="font-size:.78rem;opacity:.7">${wk.desc}</div></div><div style="font-family:var(--fd);font-size:.85rem">${done?'<span class="wc-check">‚úÖ</span>':`${prog}/${wk.goal}`}</div></div><div style="height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:6px"><div style="height:100%;background:${done?'var(--green)':'var(--gold)'};border-radius:2px;width:${Math.min(100,Math.round(prog/wk.goal*100))}%"></div></div></div>`}
// Track B progress summary
let tbProg='';
TB_GRADES.forEach(g=>{const done=S.hlb(g.id);tbProg+=`<span style="font-size:.7rem">${g.id==='K'?'üå±':''}${g.id==='1'?'üåü':''}${g.id==='2'?'üèîÔ∏è':''}${done}/${g.lvs.length}</span> `});
sc().innerHTML=`<div>${db}${potdHtml}${wkHtml}<h2 class="sh">Choose Your Path!</h2><div style="display:flex;flex-direction:column;gap:14px"><div class="trc" id="trA"><div style="font-size:1.8rem">üó°Ô∏è</div><h3>Multiplication & Division Quest</h3><p>Master √ó and √∑ across 50 levels!</p><div class="tp">Level ${h}/50 ¬∑ Next: ${nx}</div></div><div class="trc" id="trB"><div style="font-size:1.8rem">üìö</div><h3>The Good & Beautiful Math Trail</h3><p>K‚Äì2nd grade: Add, Sub & more!</p><div class="tp">${tbProg}</div></div></div><div class="mt20 tc2"><button class="btn bs bsm" id="prb">üéØ Practice</button></div></div>`;
$('trA').addEventListener('click',showMap);$('trB').addEventListener('click',showTBSelect);$('prb').addEventListener('click',showPrac);
const potdBtn=$('potdBtn');if(potdBtn)potdBtn.addEventListener('click',startPOTD);
const wkBtn=$('wkBtn');if(wkBtn)wkBtn.addEventListener('click',()=>{md('üìã Weekly Challenge',`<div style="font-size:.85rem">${wk.desc}</div><div style="font-family:var(--fd);color:var(--gold);margin-top:8px">${(p.wk&&p.wk.id===wk.id?p.wk.p:0)}/${wk.goal}</div><div style="font-size:.78rem;opacity:.7;margin-top:4px">Reward: ü™ô${wk.reward}</div>`,[{l:'OK'}])});
ub()}
// === PROBLEM OF THE DAY ===
function startPOTD(){const p=S.pf();const today=new Date().toISOString().split('T')[0];
const seed=today.split('-').join('');const pNum=(parseInt(seed)%47)+3;
const a=((pNum*7)%9)+2,b=((pNum*13)%9)+2;
const prob={d:`${a} √ó ${b} = ?`,an:a*b,tm:20};
sc().innerHTML=`<div class="tc2"><h2 class="sh">üß© Problem of the Day</h2><div style="font-family:var(--fd);font-size:2.4rem;margin:24px 0">${prob.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px;margin-bottom:8px"></div>${np()}</div>`;
let done=false;
nph=v=>{if(done)return;const b=$('ab');if(!b)return;
if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}
if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u))return;done=true;
const ok=u===prob.an;p.potd={d:today,dn:true};S.sp(p);
if(ok){A.p('ok');sb(innerWidth/2,innerHeight/3);S.ac(20);S.ax(30);
setTimeout(()=>md('üß© Correct!','+20ü™ô +30‚ö°',[{l:'Awesome!',f:showH}]),500)}
else{A.p('no');setTimeout(()=>md('üß© Not quite!',`Answer was ${prob.an}. Try tomorrow!`,[{l:'OK',f:showH}]),500)}
return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}
// === WEEKLY CHALLENGE ===
function getWeekly(){const now=new Date();const wn=Math.floor((now.getTime()-new Date(now.getFullYear(),0,1).getTime())/(7*864e5));
const challenges=[
{id:'w1',desc:'Get 30 correct answers this week',goal:30,reward:50,stat:'c'},
{id:'w2',desc:'Complete 5 levels this week',goal:5,reward:40,stat:'lv'},
{id:'w3',desc:'Win 3 arena battles this week',goal:3,reward:60,stat:'aw'},
{id:'w4',desc:'Get 10 multiplication correct',goal:10,reward:35,stat:'mc'},
{id:'w5',desc:'Score 3 perfect levels (‚≠ê‚≠ê‚≠ê)',goal:3,reward:70,stat:'pl'}
];
return{...challenges[wn%challenges.length],id:'wk'+wn}}
function updWeekly(stat){const p=S.pf();if(!p)return;const wk=getWeekly();if(!p.wk||p.wk.id!==wk.id)p.wk={id:wk.id,p:0};
if(stat===wk.stat||stat==='c'&&wk.stat==='c'||stat==='lv'&&wk.stat==='lv'||stat==='aw'&&wk.stat==='aw'||stat==='mc'&&wk.stat==='mc'||stat==='pl'&&wk.stat==='pl'){
p.wk.p++;S.sp(p);if(p.wk.p===wk.goal){S.ac(wk.reward);setTimeout(()=>md('üìã Challenge Done!',`Weekly challenge complete!<br>+ü™ô${wk.reward}`,[{l:'Awesome!'}]),800)}}}
// === TRACK A MAP ===
function showMap(){const p=S.pf(),h=S.hl();let html='<div><h2 class="sh">üó°Ô∏è Mult & Div Quest</h2><button class="btn bs bsm mb12" id="mbk">‚Üê Back</button>';
TI.forEach(t=>{html+=`<div style="margin-bottom:14px"><div style="font-family:var(--fd);color:var(--gold);font-size:1rem;margin-bottom:8px">${t.n} (${t.lv[0]}‚Äì${t.lv[1]})</div><div class="lr">`;
for(let l=t.lv[0];l<=t.lv[1];l++){const d=p.lv[l],st=d?d.s:0,ul=l<=h+1;let c='lk';if(st===3)c='pf';else if(st>0)c='cm';else if(ul)c='av';
html+=`<div class="ln ${c}" ${ul?`data-lv="${l}"`:''}><span>${l}</span><span class="st">${st>0?'‚≠ê'.repeat(st):''}</span></div>`}
html+='</div></div>'});html+='</div>';sc().innerHTML=html;$('mbk').addEventListener('click',showH);
sc().querySelectorAll('[data-lv]').forEach(n=>n.addEventListener('click',()=>stLv(+n.dataset.lv)))}
// === TRACK A LEVEL ===
let lv={};
function stLv(num){A.p('cl');const pr=[];for(let i=0;i<10;i++)pr.push(gp(num));lv={num,pr,c:0,sc:0,sk:0,ms:0,rs:[],dn:false};rLv()}
function rLv(){if(lv.c>=10){lvDone();return}lv.dn=false;const pb=lv.pr[lv.c];
let dots='';for(let i=0;i<10;i++){let c='';if(i<lv.c)c=lv.rs[i]?'c':'w';else if(i===lv.c)c='cur';dots+=`<div class="dot ${c}"></div>`}
sc().innerHTML=`<div class="tc2"><div style="display:flex;justify-content:space-between;font-size:.78rem;opacity:.6;margin-bottom:6px"><span>Level ${lv.num}</span><span>${lv.c+1}/10</span></div><div class="tc"><div class="tb" id="tb" style="width:100%"></div></div><div class="dots">${dots}</div><div id="pa"><div id="pt" style="font-family:var(--fd);font-size:2.4rem;margin:18px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px;margin-bottom:8px"></div></div>${pb.mc?mcHTML(pb.mc):np()}</div>`;
const tot=pb.tm,st=Date.now();if(tmr)clearInterval(tmr);
tmr=setInterval(()=>{if(lv.dn){clearInterval(tmr);return}const el=(Date.now()-st)/1000,pct=Math.max(0,((tot-el)/tot)*100);const bar=$('tb');if(bar){bar.style.width=pct+'%';bar.className='tb'+(pct<25?' td':pct<50?' tw':'')}if(el>=tot){clearInterval(tmr);subA(null,true)}},50);
if(pb.mc){setupMC(pb)}else{
nph=v=>{if(lv.dn)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u)&&b.textContent!=='0')return;subA(b.textContent==='0'?0:u);return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}}
function mcHTML(opts){return`<div class="mc-opt">${opts.map(o=>`<button class="mc-btn" data-mc="${o}">${o}</button>`).join('')}</div>`}
function setupMC(pb){nph=null;sc().querySelectorAll('[data-mc]').forEach(b=>b.addEventListener('click',()=>{if(lv.dn)return;subA(+b.dataset.mc)}))}
function subA(ua,to){if(lv.dn)return;lv.dn=true;if(tmr)clearInterval(tmr);const pb=lv.pr[lv.c],ok=!to&&parseInt(ua)===pb.an;lv.rs.push(ok);
const p=S.pf();p.st.a++;
if(ok){lv.sc++;lv.sk++;if(lv.sk>lv.ms)lv.ms=lv.sk;A.p('ok');sb(innerWidth/2,innerHeight/3);p.st.c++;p.st.cs++;if(p.st.cs>p.st.bs)p.st.bs=p.st.cs;if(pb.tp==='m')p.st.mc++;else if(pb.tp==='d')p.st.dc++;else if(pb.tp==='a')p.st.ac++;else if(pb.tp==='s')p.st.sc++;updWeekly('c');if(pb.tp==='m')updWeekly('mc')}
else{lv.sk=0;A.p('no');p.st.cs=0}S.sp(p);
const pt=$('pt');if(pt)pt.innerHTML=ok?'<span style="color:var(--green)">‚úÖ Correct!</span>':`<span style="color:var(--red)">‚ùå ${to?"Time's up!":"Nope!"} = ${pb.an}</span>`;
setTimeout(()=>{lv.c++;rLv()},1300)}
function lvDone(){nph=null;const s=lv.sc,st=s>=9?3:s>=5?2:s>=1?1:0,xp=s*10+(s===10?50:0),co=s+(s===10?5:0);
S.ax(xp);S.ac(co);const isB=typeof lv.num==='string'&&lv.num.startsWith('b');S.sl(lv.num,s);
if(s===10){const p=S.pf();p.st.pl=(p.st.pl||0)+1;S.sp(p);updWeekly('pl')}updWeekly('lv');
const p=S.pf();if(s>0)tt(1);if(p.st.mc>=10)tt(2);if(p.st.dc>=10)tt(3);if(p.st.ac>=25)tt(4);if(p.st.sc>=25)tt(5);if(lv.ms>=5)tt(6);if(s===10)tt(7);if(p.st.c>=100)tt(8);if(p.pl.sk>=7)tt(14);if((p.st.pl||0)>=5)tt(15);
if(!isB){function ad(a,b){for(let i=a;i<=b;i++)if(!p.lv[i]||p.lv[i].s<1)return false;return true}
if(ad(1,10))tt(16);if(ad(11,20))tt(17);if(ad(21,30))tt(18);if(ad(31,40))tt(19);if(ad(41,50))tt(20)}
else{function abd(g){const gr2=TB_GRADES.find(x=>x.id===g);if(!gr2)return false;for(const l of gr2.lvs)if(!p.blv[l]||p.blv[l].s<1)return false;return true}
if(abd('K'))tt(21);if(abd('1'))tt(22);if(abd('2'))tt(23)}
A.p('done');cf();const ss='‚≠ê'.repeat(st)+'‚òÜ'.repeat(3-st),msg=s===10?'PERFECT! üéâ':s>=7?'Great job! üëè':s>=4?'Good effort! üí™':'Keep going! üåü';
const lvLabel=isB?getTBLevel(lv.num)?.n||lv.num:`Level ${lv.num}`;
sc().innerHTML=`<div class="tc2" style="padding-top:20px"><h2 style="font-family:var(--fd);color:var(--gold);font-size:1.5rem">${lvLabel} Complete!</h2><div style="font-size:2.2rem;margin:10px 0;letter-spacing:6px">${ss}</div><div style="font-family:var(--fd);font-size:2.5rem">${s}/10</div><p style="margin:12px 0">${msg}</p><div style="display:flex;justify-content:center;gap:20px;margin:14px 0"><div style="font-family:var(--fd);font-size:1.1rem">‚ö°<span id="xc">0</span></div><div style="font-family:var(--fd);font-size:1.1rem">ü™ô<span id="cc">0</span></div></div><div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:16px"><button class="btn bs" id="rty">üîÑ Retry</button>${isB?'<button class="btn bp" id="nxtb">Next ‚Üí</button><button class="btn bs" id="bmapb">üìç Map</button>':st>0&&lv.num<50?'<button class="btn bp" id="nxt">Next ‚Üí</button>':''}${!isB?'<button class="btn bs" id="bmap">üìç Map</button>':''}</div></div>`;
setTimeout(()=>{an($('xc'),xp);an($('cc'),co)},300);
$('rty').addEventListener('click',()=>{if(isB)stLvB(lv.num);else stLv(lv.num)});
const nx=$('nxt');if(nx)nx.addEventListener('click',()=>stLv(lv.num+1));
const nxb=$('nxtb');if(nxb)nxb.addEventListener('click',()=>{const idx=TB.findIndex(t=>t.lv===lv.num);if(idx>=0&&idx<TB.length-1)stLvB(TB[idx+1].lv);else showTBSelect()});
const bm=$('bmap');if(bm)bm.addEventListener('click',showMap);
const bmb=$('bmapb');if(bmb)bmb.addEventListener('click',showTBSelect);
ub()}
// === TRACK B ===
function showTBSelect(){sc().innerHTML=`<div><h2 class="sh">üìö Math Trail</h2><button class="btn bs bsm mb12" id="tbbk">‚Üê Back</button>${TB_GRADES.map(g=>{const done=S.hlb(g.id),tot=g.lvs.length;return`<div class="grade-card" data-gr="${g.id}" style="border-left:4px solid ${g.c}"><h3>${g.n}</h3><p>${g.sub}</p><div style="font-size:.78rem;opacity:.7;margin-top:4px">${done}/${tot} complete</div><div style="height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:4px"><div style="height:100%;background:${g.c};border-radius:2px;width:${Math.round(done/tot*100)}%"></div></div></div>`}).join('')}</div>`;
$('tbbk').addEventListener('click',showH);
sc().querySelectorAll('[data-gr]').forEach(c=>c.addEventListener('click',()=>showTBMap(c.dataset.gr)))}
function showTBMap(grade){const g=TB_GRADES.find(x=>x.id===grade);if(!g)return;const p=S.pf();const h=S.hlb(grade);
let html=`<div><h2 class="sh">${g.n}</h2><button class="btn bs bsm mb12" id="tmbk">‚Üê Back</button><div class="lr">`;
g.lvs.forEach((lv,i)=>{const d=p.blv[lv],st=d?d.s:0,ul=i<=h;let c='lk';if(st===3)c='pf';else if(st>0)c='cm';else if(ul)c='av';
const tbl=getTBLevel(lv);
html+=`<div class="ln ${c}" ${ul?`data-blv="${lv}"`:''}><span>${i+1}</span><span class="st">${st>0?'‚≠ê'.repeat(st):''}</span></div>`});
html+='</div></div>';sc().innerHTML=html;$('tmbk').addEventListener('click',showTBSelect);
sc().querySelectorAll('[data-blv]').forEach(n=>n.addEventListener('click',()=>stLvB(n.dataset.blv)))}
function stLvB(lvId){A.p('cl');const pr=[];for(let i=0;i<10;i++)pr.push(gpb(lvId));lv={num:lvId,pr,c:0,sc:0,sk:0,ms:0,rs:[],dn:false};rLv()}
// === ARENA (Phase 2 - with boss battles) ===
function showAr(){const p=S.pf();if(!p)return;const h=S.hl();
if(h<5){sc().innerHTML=`<div class="tc2" style="padding-top:40px"><div style="font-size:3rem">üîí</div><h2 class="sh">Arena Locked</h2><p style="opacity:.7">Reach Level 5! (${h}/5)</p></div>`;return}
if(!p.dg.ac){sc().innerHTML='<div class="tc2" style="padding-top:40px"><p>Get a dragon first! üêâ</p></div>';return}
const ds=S.ds(p.dg.ac);let html=`<div><h2 class="sh">‚öîÔ∏è Battle Arena</h2><div class="card cg mb12" style="display:flex;align-items:center;gap:12px"><span style="font-size:2rem">${ds.em}</span><div style="flex:1"><div style="font-family:var(--fd);font-size:.88rem;color:var(--gold)">${ds.dn}</div><div style="font-size:.72rem;opacity:.7">‚öîÔ∏è${ds.power} üí®${ds.speed} üß†${ds.wisdom} ‚ù§Ô∏è${ds.hp}</div></div><button class="btn bs bsm" id="isb">üß™ Items</button></div>`;
// Solo arena tiers
html+='<div style="font-family:var(--fd);color:var(--gold);margin:12px 0 6px">Solo Arena</div>';
AT.forEach(t=>{const ul=h>=t.ul,af=p.xs>=t.cost;html+=`<div class="ac${ul?'':' al'}" ${ul?`data-ar="${t.id}"`:''} ${ul?'style="cursor:pointer"':''}><span style="font-size:1.8rem">${t.ic}</span><div style="flex:1"><div style="font-family:var(--fd);font-size:.95rem">${t.n}</div><div style="font-size:.75rem;opacity:.7">${ul?'Tier '+t.df:'Unlock Lv'+t.ul}</div></div><span style="font-family:var(--fd);font-size:.85rem;color:var(--purple-p)">${ul?'‚ö°'+t.cost:'üîí'}</span></div>`});
// Boss battles
html+='<div style="font-family:var(--fd);color:var(--red);margin:16px 0 6px">üíÄ Boss Battles</div>';
BOSSES.forEach((b,i)=>{const ul=h>=10*(i+1),beaten=p.an.bk&&p.an.bk[b.id];
html+=`<div class="ac${ul?'':' al'}" ${ul?`data-boss="${b.id}"`:''} ${ul?'style="cursor:pointer"':''}><span style="font-size:1.8rem">${beaten?'üíÄ':'üëπ'}</span><div style="flex:1"><div style="font-family:var(--fd);font-size:.95rem">${b.n}</div><div style="font-size:.75rem;opacity:.7">${ul?b.abt:'Unlock Lv'+(10*(i+1))}</div></div><span style="font-size:.78rem">${beaten?'<span style="color:var(--green)">‚úÖ Beaten</span>':ul?`‚ö°${b.rw.f}`:'üîí'}</span></div>`});
// Multiplayer
html+=`<div style="font-family:var(--fd);color:var(--purple-p);margin:16px 0 6px">ü§ù Dragon Clash</div>
<div class="ac" id="mpLocal" style="cursor:pointer"><span style="font-size:1.8rem">üéÆ</span><div style="flex:1"><div style="font-family:var(--fd);font-size:.95rem">Same Device</div><div style="font-size:.75rem;opacity:.7">Hot-seat battle!</div></div></div>
<div class="ac" id="mpCode" style="cursor:pointer"><span style="font-size:1.8rem">üì¨</span><div style="flex:1"><div style="font-family:var(--fd);font-size:.95rem">Challenge Code</div><div style="font-size:.75rem;opacity:.7">Async challenge!</div></div></div>`;
html+=`<div class="card mt16 tc2"><div style="font-family:var(--fd);font-size:.85rem;color:var(--gold)">Record</div><div style="font-size:.82rem">Solo W:${p.an.w} L:${p.an.l} ¬∑ MP W:${p.mp.w} L:${p.mp.l}</div></div></div>`;
sc().innerHTML=html;$('isb').addEventListener('click',showIS);
sc().querySelectorAll('[data-ar]').forEach(c=>c.addEventListener('click',()=>stBt(c.dataset.ar)));
sc().querySelectorAll('[data-boss]').forEach(c=>c.addEventListener('click',()=>stBoss(c.dataset.boss)));
$('mpLocal').addEventListener('click',showMPLocal);
$('mpCode').addEventListener('click',showMPCode)}
// === SOLO BATTLE ENGINE ===
let bt=null;
function stBt(tid){const t=AT.find(x=>x.id===tid);if(!t)return;const p=S.pf();
if(p.xs<t.cost){md('Not Enough XP!',`Need ‚ö°${t.cost}.`,[{l:'OK'}]);return}
S.sx(t.cost);ub();A.p('rr');const ds=S.ds(p.dg.ac);
const ee=Object.keys(EL),el=ee[ri(0,5)],en=['Wild Hatchling','Feral Whelp','Rogue Drake','Shadow Prowler','Storm Runner','Frost Stalker','Ember Thief','Vine Snapper'];
const enemy={nm:en[ri(0,en.length-1)],el,pw:ri(t.epw[0],t.epw[1]),hp:ri(t.ehp[0],t.ehp[1]),em:EL[el].i};enemy.mhp=enemy.hp;
bt={t,pd:{...ds,ch:ds.hp},en:{...enemy},tn:1,mt:10,ok:0,tot:0,df:t.df,pl:ds.stage===3?2:1,ef:{},ui:false,it:{...p.an.it},dn:false,isBoss:false};rBt()}
function rBt(){if(!bt||bt.dn)return;if(bt.pd.ch<=0){eBt(false);return}if(bt.en.hp<=0){eBt(true);return}if(bt.tn>bt.mt){eBt(bt.pd.ch>bt.en.hp);return}
if(bt.isBoss&&bt.boss){const b=bt.boss;
if(b.ab==='rage'&&bt.en.hp<bt.en.mhp*.4)bt.ef.brage=true;
if(b.ab==='regrow'&&bt.tn%3===0&&bt.tn>1){bt.en.hp=Math.min(bt.en.mhp,bt.en.hp+Math.floor(bt.en.mhp*.15))}
if(b.ab==='freeze'&&bt.tn%3===0&&bt.tn>1)bt.ef.frozen=true;
if(b.ab==='tidal'&&bt.tn%4===0)bt.ef.reversed=true;else bt.ef.reversed=false}
const pb=bt.isBoss?gp(TI[Math.min(bt.df,4)].lv[0]):gp(TI[Math.min(bt.df-1,4)].lv[0]);
if(bt.ef.reversed){pb.d=pb.d.split('').reverse().join('')}
bt._p=pb;bt._a=false;
const pH=Math.max(0,(bt.pd.ch/bt.pd.hp)*100),eH=Math.max(0,(bt.en.hp/bt.en.mhp)*100);
const pc=pH>60?'hh':pH>30?'hm':'hl',ec=eH>60?'hh':eH>30?'hm':'hl';
const timer=bt.ef.frozen?Math.max(5,pb.tm-5):(pb.tm+Math.floor(bt.pd.wisdom/20));
let ib='';for(const[k,c]of Object.entries(bt.it)){if(c>0){const it=IT[k];ib+=`<button class="btn bs bsm" data-bi="${k}">${it.ic}(${c})</button>`}}
let bw='';if(bt.ef.frozen)bw='<div style="color:#85C1E9;font-size:.72rem;text-align:center">‚ùÑÔ∏è Frozen! Reduced time!</div>';
if(bt.ef.reversed)bw='<div style="color:#3498DB;font-size:.72rem;text-align:center">üåä Numbers reversed!</div>';
if(bt.ef.brage)bw='<div style="color:var(--red);font-size:.72rem;text-align:center">üò° RAGE MODE!</div>';
sc().innerHTML=`<div><div style="font-size:.72rem;text-align:center;opacity:.5;margin-bottom:4px">${bt.isBoss?'BOSS':'Turn'} ${bt.tn}/${bt.mt}</div>${bw}<div style="display:flex;justify-content:space-between;gap:8px"><div style="text-align:center;flex:1"><div style="font-size:2.5rem" id="ps">${bt.pd.em}</div><div style="font-family:var(--fd);font-size:.78rem;color:var(--gold)">${bt.pd.dn}</div><div class="hpc"><div class="hpb ${pc}" style="width:${pH}%"></div><div class="hpt">${bt.pd.ch}/${bt.pd.hp}</div></div></div><div style="font-family:var(--fd);color:var(--red);align-self:center;padding-top:16px">‚öîÔ∏è</div><div style="text-align:center;flex:1"><div style="font-size:2.5rem" id="es">${bt.en.em}</div><div style="font-family:var(--fd);font-size:.78rem;color:var(--red)">${bt.en.nm}</div><div class="hpc"><div class="hpb ${ec}" style="width:${eH}%"></div><div class="hpt">${bt.en.hp}/${bt.en.mhp}</div></div></div></div><div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin:8px 0">${bt.pl>0?`<button class="btn bs bsm" id="pwb">‚ú®Power(${bt.pl})</button>`:''}${ib}</div><div class="tc"><div class="tb" id="btb" style="width:100%"></div></div><div id="bp" class="tc2"><div style="font-family:var(--fd);font-size:2rem;margin:10px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:1.8rem;color:var(--gold);min-height:40px;border-bottom:3px solid var(--gold);display:inline-block;min-width:80px;padding:4px 8px;margin-bottom:6px"></div></div>${np()}</div>`;
const pwb=$('pwb');if(pwb)pwb.addEventListener('click',()=>{if(bt.pl<=0)return;bt.pl--;if(bt.pd.e==='forest'){bt.pd.ch=Math.min(bt.pd.ch+Math.floor(bt.pd.hp*(bt.pd.stage>=2?.4:.25)),bt.pd.hp)}else bt.ef.dm=bt.pd.stage>=2?2.5:2;A.p('pw');rBt()});
sc().querySelectorAll('[data-bi]').forEach(b=>b.addEventListener('click',()=>{const k=b.dataset.bi;if(bt.it[k]<=0)return;bt.it[k]--;bt.ui=true;if(k==='healing_potion')bt.pd.ch=Math.min(bt.pd.ch+Math.floor(bt.pd.hp*.3),bt.pd.hp);else if(k==='iron_shield'){bt.ef.sh=2;bt.ef.sr=.5}else if(k==='focus_gem')bt.ef.fg=true;const p=S.pf();if(p.an.it[k]>0){p.an.it[k]--;S.sp(p)}A.p('cn');rBt()}));
const start=Date.now();if(tmr)clearInterval(tmr);tmr=setInterval(()=>{if(bt._a){clearInterval(tmr);return}const el=(Date.now()-start)/1000,pct=Math.max(0,((timer-el)/timer)*100);const bar=$('btb');if(bar){bar.style.width=pct+'%';bar.className='tb'+(pct<25?' td':pct<50?' tw':'')}if(el>=timer){clearInterval(tmr);rsBt(null,true)}},50);
nph=v=>{if(bt._a)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const a=parseInt(b.textContent);if(isNaN(a)&&b.textContent!=='0')return;rsBt(b.textContent==='0'?0:a);return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}
function rsBt(ua,to){if(!bt||bt._a)return;bt._a=true;if(tmr)clearInterval(tmr);let ok=!to&&parseInt(ua)===bt._p.an;
if(!ok&&bt.ef.fg){ok=true;delete bt.ef.fg}bt.tot++;if(ok)bt.ok++;
let pd=0;if(ok){pd=Math.floor(bt.pd.power*(1+bt.pd.alv*.1)*em(bt.pd.e,bt.en.el));if(bt.ef.dm){pd=Math.floor(pd*bt.ef.dm);delete bt.ef.dm}
if(bt.isBoss&&bt.boss&&bt.boss.ab==='veil'){if(Math.random()<(bt.en.hp<bt.en.mhp*.3?.5:.3))pd=0}
if(bt.pd.e==='shadow')bt.pd.ch=Math.min(bt.pd.ch+Math.floor(pd*(bt.pd.stage>=2?.2:.15)),bt.pd.hp);bt.en.hp=Math.max(0,bt.en.hp-pd)}
let ed=Math.floor(bt.en.pw*(ok?.7:.5)*(1-bt.pd.dr));
if(bt.ef.brage)ed=Math.floor(ed*2);
if(bt.ef.sh>0){ed=Math.floor(ed*(1-bt.ef.sr));bt.ef.sh--}
if(Math.random()<bt.pd.charm/200)ed=Math.floor(ed*.5);if(Math.random()<bt.pd.speed/200)ed=0;
bt.pd.ch=Math.max(0,bt.pd.ch-ed);
A.p(ok?'at':'ht');const bp=$('bp');if(bp)bp.innerHTML=`<div style="font-size:1rem;margin:8px 0">${ok?`<span style="color:var(--green)">‚úÖ Hit! ‚àí${pd}</span>`:`<span style="color:var(--red)">‚ùå Miss!</span>`}</div>${ed>0?`<div style="font-size:.85rem;color:var(--red)">Enemy ‚àí${ed}</div>`:''}`;
bt.tn++;setTimeout(rBt,1600)}
function eBt(won){bt.dn=true;nph=null;if(tmr)clearInterval(tmr);const p=S.pf();
if(won){p.an.w++;if(p.dg.wi[p.dg.ac]!==undefined)p.dg.wi[p.dg.ac]++;if(p.dg.fr[p.dg.ac]!==undefined)p.dg.fr[p.dg.ac]=Math.min(100,p.dg.fr[p.dg.ac]+5);
if(bt.isBoss){p.an.bk=p.an.bk||{};p.an.bk[bt.boss.id]=true;S.sp(p);const co=bt.boss.rw.r,xp=bt.boss.rw.f;S.ac(co);S.ax(xp);A.p('vc');cf();tt(25);if(bt.boss.id==='B6')tt(26);
sc().innerHTML=`<div class="tc2" style="padding-top:20px"><div style="font-size:3.5rem">üíÄ</div><h2 style="font-family:var(--fd);color:var(--gold)">BOSS DEFEATED!</h2><p>${bt.boss.n} has fallen!</p><div style="display:flex;justify-content:center;gap:16px;margin:10px 0;font-family:var(--fd)"><span>‚ö°+${xp}</span><span>ü™ô+${co}</span></div><button class="btn bp mt16" id="abk">Back to Arena</button></div>`}
else{S.sp(p);const co=10+Math.floor(bt.ok*1.5),xp=bt.ok*10;S.ac(co);S.ax(xp);A.p('vc');cf();tt(24);updWeekly('aw');
const score=bt.ok*100+Math.floor((bt.pd.ch/bt.pd.hp)*5000)+(!bt.ui?200:0);if(score>=2000)tt(27);
sc().innerHTML=`<div class="tc2" style="padding-top:20px"><div style="font-size:3.5rem">üéâ</div><h2 style="font-family:var(--fd);color:var(--green)">Victory!</h2><p>Defeated ${bt.en.nm}!</p><div style="font-family:var(--fd);font-size:1.8rem;margin:10px 0">Score: ${score}</div><div style="display:flex;justify-content:center;gap:16px;margin:10px 0;font-family:var(--fd)"><span>‚ö°+${xp}</span><span>ü™ô+${co}</span></div><button class="btn bp mt16" id="abk">Back to Arena</button></div>`}}
else{p.an.l++;S.sp(p);A.p('df');sc().innerHTML=`<div class="tc2" style="padding-top:20px"><div style="font-size:3.5rem">üòî</div><h2 style="font-family:var(--fd);color:var(--red)">Defeated...</h2><p>${bt.isBoss?bt.boss.n+' stands victorious.':'Train more!'}</p><p style="font-size:.85rem;opacity:.7">${bt.ok}/${bt.tot} correct</p><button class="btn bp mt16" id="abk">Arena</button></div>`}
$('abk').addEventListener('click',()=>swt('arena'));ub();bt=null}
// === BOSS BATTLES ===
function stBoss(bossId){const boss=getBoss(bossId);if(!boss)return;const p=S.pf();
if(p.xs<boss.rw.f){md('Not Enough XP!',`Need ‚ö°${boss.rw.f}.`,[{l:'OK'}]);return}
S.sx(boss.rw.f);ub();
const intro=document.createElement('div');intro.className='boss-intro';
intro.innerHTML=`<div style="font-size:6rem">üëπ</div><div class="bname">${boss.n}</div><div class="bability">${boss.abt}</div><div style="font-size:.78rem;opacity:.5;margin-top:8px;font-style:italic">"${boss.fl}"</div>`;
document.body.appendChild(intro);A.p('boss');
setTimeout(()=>{intro.remove();const ds=S.ds(p.dg.ac);
const enemy={nm:boss.n,el:boss.e,pw:boss.pw,hp:boss.hp,em:'üëπ',mhp:boss.hp};
bt={t:null,pd:{...ds,ch:ds.hp},en:{...enemy},tn:1,mt:12,ok:0,tot:0,df:Math.min(4,BOSSES.indexOf(boss)+1),pl:ds.stage===3?2:1,ef:{},ui:false,it:{...p.an.it},dn:false,isBoss:true,boss};rBt()},2500)}
// === MULTIPLAYER: SAME DEVICE ===
let mpGame=null;
function showMPLocal(){sc().innerHTML=`<div class="tc2"><h2 class="sh">üéÆ Same-Device Battle</h2><p style="font-size:.85rem;opacity:.7">Take turns solving problems!</p><div style="margin:16px 0"><div style="font-family:var(--fd);margin-bottom:8px">Player 2 Name:</div><input type="text" class="inf" id="p2name" maxlength="15" placeholder="Player 2" style="max-width:200px;text-align:center" autocomplete="off"></div><div style="font-family:var(--fd);margin-bottom:8px">Difficulty:</div><div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:16px">${TI.map((t,i)=>`<button class="btn bs bsm" data-mpd="${i}">${t.n}</button>`).join('')}</div><button class="btn bs bsm mt12" id="mpbk">‚Üê Back</button></div>`;
$('mpbk').addEventListener('click',()=>swt('arena'));
sc().querySelectorAll('[data-mpd]').forEach(b=>b.addEventListener('click',()=>{const nm=($('p2name').value||'').trim()||'Player 2';startMPLocal(nm,+b.dataset.mpd)}))}
function startMPLocal(p2name,df){const p=S.pf();const pr=[];for(let i=0;i<10;i++)pr.push(gp(TI[df].lv[0]));
mpGame={p1:{nm:p.pl.nm,sc:0},p2:{nm:p2name,sc:0},pr,c:0,phase:'p1',df};rMPTurn()}
function rMPTurn(){if(!mpGame)return;if(mpGame.c>=10){endMPLocal();return}
const who=mpGame.phase==='p1'?mpGame.p1:mpGame.p2;
const shield=document.createElement('div');shield.className='privacy-shield';
shield.innerHTML=`<h2>${who.nm}'s Turn!</h2><div style="font-size:3rem;margin:12px 0">${mpGame.phase==='p1'?'üêâ':'üê≤'}</div><div style="font-size:.85rem;opacity:.7;margin-bottom:16px">Problem ${mpGame.c+1}/10</div><button class="btn bp" id="mpgo">Ready!</button>`;
document.body.appendChild(shield);$('mpgo').addEventListener('click',()=>{shield.remove();showMPProblem()})}
function showMPProblem(){const pb=mpGame.pr[mpGame.c];const who=mpGame.phase==='p1'?mpGame.p1:mpGame.p2;
sc().innerHTML=`<div class="tc2"><div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:8px"><span style="color:var(--gold)">${who.nm}</span><span>${mpGame.c+1}/10</span><span>Score: ${who.sc}</span></div><div class="tc"><div class="tb" id="mtb" style="width:100%"></div></div><div style="font-family:var(--fd);font-size:2.2rem;margin:18px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px;margin-bottom:8px"></div>${np()}</div>`;
const timer=pb.tm;const start=Date.now();let done=false;
if(tmr)clearInterval(tmr);
tmr=setInterval(()=>{if(done){clearInterval(tmr);return}const el=(Date.now()-start)/1000,pct=Math.max(0,((timer-el)/timer)*100);const bar=$('mtb');if(bar){bar.style.width=pct+'%';bar.className='tb'+(pct<25?' td':pct<50?' tw':'')}if(el>=timer){clearInterval(tmr);done=true;mpSubmit(null,true)}},50);
nph=v=>{if(done)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u))return;done=true;if(tmr)clearInterval(tmr);mpSubmit(u);return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}
function mpSubmit(ua,to){const pb=mpGame.pr[mpGame.c];const ok=!to&&parseInt(ua)===pb.an;
const who=mpGame.phase==='p1'?mpGame.p1:mpGame.p2;
if(ok){who.sc++;A.p('ok');sb(innerWidth/2,innerHeight/3)}else A.p('no');
if(mpGame.phase==='p1'){mpGame.phase='p2';setTimeout(rMPTurn,1200)}
else{mpGame.phase='p1';mpGame.c++;setTimeout(rMPTurn,1200)}}
function endMPLocal(){nph=null;if(tmr)clearInterval(tmr);
const w=mpGame.p1.sc>mpGame.p2.sc?mpGame.p1.nm:mpGame.p2.sc>mpGame.p1.sc?mpGame.p2.nm:'Tie!';
const p=S.pf();
if(mpGame.p1.sc>mpGame.p2.sc){p.mp.w++;S.sp(p);tt(28);if(p.mp.w>=10)tt(29)}
else if(mpGame.p2.sc>mpGame.p1.sc){p.mp.l++;S.sp(p)}else S.sp(p);
A.p(mpGame.p1.sc>=mpGame.p2.sc?'vc':'df');if(mpGame.p1.sc>mpGame.p2.sc)cf();
sc().innerHTML=`<div class="tc2" style="padding-top:20px"><div style="font-size:3rem">${w==='Tie!'?'ü§ù':'üèÜ'}</div><h2 style="font-family:var(--fd);color:var(--gold)">${w==='Tie!'?'Tie!':w+' Wins!'}</h2><div style="display:flex;justify-content:center;gap:30px;margin:16px 0"><div class="tc2"><div style="font-family:var(--fd);color:var(--gold)">${mpGame.p1.nm}</div><div style="font-family:var(--fd);font-size:1.8rem">${mpGame.p1.sc}/10</div></div><div class="tc2"><div style="font-family:var(--fd);color:var(--purple-p)">${mpGame.p2.nm}</div><div style="font-family:var(--fd);font-size:1.8rem">${mpGame.p2.sc}/10</div></div></div><div style="display:flex;gap:10px;justify-content:center;margin-top:16px"><button class="btn bp" id="mpag">Rematch</button><button class="btn bs" id="mpbk2">Arena</button></div></div>`;
$('mpag').addEventListener('click',()=>startMPLocal(mpGame.p2.nm,mpGame.df));
$('mpbk2').addEventListener('click',()=>swt('arena'));mpGame=null;ub()}
// === MULTIPLAYER: CHALLENGE CODE ===
function showMPCode(){sc().innerHTML=`<div class="tc2"><h2 class="sh">üì¨ Challenge Code</h2><p style="font-size:.85rem;opacity:.7">Create a challenge or enter a code!</p><div style="display:flex;flex-direction:column;gap:12px;margin-top:16px"><button class="btn bp" id="mkcode">Create Challenge</button><button class="btn bs" id="encode">Enter Code</button><button class="btn bs bsm mt12" id="mpbk3">‚Üê Back</button></div></div>`;
$('mkcode').addEventListener('click',createChallenge);$('encode').addEventListener('click',enterChallenge);$('mpbk3').addEventListener('click',()=>swt('arena'))}
function createChallenge(){sc().innerHTML=`<div class="tc2"><h2 class="sh">üì¨ Create Challenge</h2><div style="font-family:var(--fd);margin-bottom:8px">Difficulty:</div><div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">${TI.map((t,i)=>`<button class="btn bs bsm" data-ccd="${i}">${t.n}</button>`).join('')}</div><button class="btn bs bsm mt16" id="ccbk">‚Üê Back</button></div>`;
$('ccbk').addEventListener('click',showMPCode);
sc().querySelectorAll('[data-ccd]').forEach(b=>b.addEventListener('click',()=>{const df=+b.dataset.ccd;const pr=[];for(let i=0;i<10;i++)pr.push(gp(TI[df].lv[0]));mpGame={pr,c:0,sc:0,df,mode:'create'};rCC()}))}
function rCC(){if(!mpGame)return;if(mpGame.c>=10){finCC();return}
const pb=mpGame.pr[mpGame.c];
sc().innerHTML=`<div class="tc2"><div style="font-size:.78rem;opacity:.6;margin-bottom:6px">Challenge ${mpGame.c+1}/10</div><div class="tc"><div class="tb" id="ctb" style="width:100%"></div></div><div style="font-family:var(--fd);font-size:2.2rem;margin:18px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px;margin-bottom:8px"></div>${np()}</div>`;
const timer=pb.tm;const start=Date.now();let done=false;
if(tmr)clearInterval(tmr);tmr=setInterval(()=>{if(done){clearInterval(tmr);return}const el=(Date.now()-start)/1000,pct=Math.max(0,((timer-el)/timer)*100);const bar=$('ctb');if(bar){bar.style.width=pct+'%';bar.className='tb'+(pct<25?' td':pct<50?' tw':'')}if(el>=timer){clearInterval(tmr);done=true;A.p('no');mpGame.c++;setTimeout(rCC,800)}},50);
nph=v=>{if(done)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u))return;done=true;if(tmr)clearInterval(tmr);if(u===pb.an){mpGame.sc++;A.p('ok');sb(innerWidth/2,innerHeight/3)}else A.p('no');mpGame.c++;setTimeout(rCC,800);return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}
function finCC(){nph=null;const code='DMA'+mpGame.df+mpGame.sc.toString(16).toUpperCase()+Date.now().toString(36).slice(-4).toUpperCase();
sc().innerHTML=`<div class="tc2"><h2 class="sh">üì¨ Challenge Created!</h2><div style="font-family:var(--fd);margin:8px 0">Your Score: ${mpGame.sc}/10</div><div style="font-size:.85rem;opacity:.7;margin-bottom:12px">Share this code:</div><div class="challenge-code" id="ccode">${code}</div><div style="margin-top:12px"><button class="btn bs bsm" id="cpcode">üìã Copy</button></div><button class="btn bp mt16" id="ccdone">Done</button></div>`;
$('cpcode').addEventListener('click',()=>{navigator.clipboard.writeText(code).catch(()=>{});md('Copied!','Share the code!',[{l:'OK'}])});
$('ccdone').addEventListener('click',showMPCode);mpGame=null}
function enterChallenge(){sc().innerHTML=`<div class="tc2"><h2 class="sh">üì¨ Enter Code</h2><input type="text" class="inf" id="cci" maxlength="12" placeholder="Enter code" style="max-width:240px;text-align:center;font-family:var(--fd);letter-spacing:3px;text-transform:uppercase" autocomplete="off"><div class="mt16"><button class="btn bp" id="ccgo">Start!</button></div><button class="btn bs bsm mt12" id="ccbk2">‚Üê Back</button></div>`;
$('ccbk2').addEventListener('click',showMPCode);
$('ccgo').addEventListener('click',()=>{const code=$('cci').value.trim().toUpperCase();if(code.length<5){md('Oops!','Enter a valid code.',[{l:'OK'}]);return}
const df=parseInt(code.charAt(3));const osc=parseInt(code.charAt(4),16);
if(isNaN(df)||df<0||df>4){md('Invalid','Bad code.',[{l:'OK'}]);return}
const pr=[];for(let i=0;i<10;i++)pr.push(gp(TI[df].lv[0]));mpGame={pr,c:0,sc:0,df,mode:'reply',opScore:osc,code};rCR()});
setTimeout(()=>$('cci').focus(),100)}
function rCR(){if(!mpGame)return;if(mpGame.c>=10){finCR();return}
const pb=mpGame.pr[mpGame.c];
sc().innerHTML=`<div class="tc2"><div style="font-size:.78rem;opacity:.6;margin-bottom:6px">Challenge ${mpGame.c+1}/10</div><div class="tc"><div class="tb" id="rtb" style="width:100%"></div></div><div style="font-family:var(--fd);font-size:2.2rem;margin:18px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px;margin-bottom:8px"></div>${np()}</div>`;
const timer=pb.tm;const start=Date.now();let done=false;
if(tmr)clearInterval(tmr);tmr=setInterval(()=>{if(done){clearInterval(tmr);return}const el=(Date.now()-start)/1000,pct=Math.max(0,((timer-el)/timer)*100);const bar=$('rtb');if(bar){bar.style.width=pct+'%';bar.className='tb'+(pct<25?' td':pct<50?' tw':'')}if(el>=timer){clearInterval(tmr);done=true;A.p('no');mpGame.c++;setTimeout(rCR,800)}},50);
nph=v=>{if(done)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u))return;done=true;if(tmr)clearInterval(tmr);if(u===pb.an){mpGame.sc++;A.p('ok');sb(innerWidth/2,innerHeight/3)}else A.p('no');mpGame.c++;setTimeout(rCR,800);return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}
function finCR(){nph=null;const p=S.pf();const won=mpGame.sc>mpGame.opScore;const tied=mpGame.sc===mpGame.opScore;
if(won){p.mp.w++;S.sp(p);tt(28);tt(30);if(p.mp.w>=10)tt(29);A.p('vc');cf()}else if(!tied){p.mp.l++;S.sp(p);A.p('df')}else{A.p('done');S.sp(p)}
sc().innerHTML=`<div class="tc2" style="padding-top:20px"><div style="font-size:3rem">${won?'üèÜ':tied?'ü§ù':'üòî'}</div><h2 style="font-family:var(--fd);color:${won?'var(--gold)':tied?'var(--purple-p)':'var(--red)'}">${won?'You Win!':tied?'Tie!':'You Lose!'}</h2><div style="display:flex;justify-content:center;gap:30px;margin:16px 0"><div class="tc2"><div style="font-size:.8rem;opacity:.7">You</div><div style="font-family:var(--fd);font-size:1.8rem;color:var(--gold)">${mpGame.sc}/10</div></div><div class="tc2"><div style="font-size:.8rem;opacity:.7">Opponent</div><div style="font-family:var(--fd);font-size:1.8rem;color:var(--purple-p)">${mpGame.opScore}/10</div></div></div><button class="btn bp mt16" id="crbk">Back</button></div>`;
$('crbk').addEventListener('click',showMPCode);mpGame=null;ub()}
// === DRAGONS ===
function showDr(){const p=S.pf();if(!p)return;let h='<div><h2 class="sh">üêâ My Dragons</h2>';
if(p.dg.ac){const ds=S.ds(p.dg.ac);if(ds){const el=EL[ds.e];h+=`<div class="card cg mb12" style="display:flex;align-items:center;gap:12px"><span style="font-size:2.2rem">${ds.em}</span><div style="flex:1"><div style="font-family:var(--fd);color:var(--gold);font-size:.88rem">${ds.dn}</div><div style="font-size:.72rem;opacity:.7">${el.i}${el.n} Stg${ds.stage} üõ°Ô∏è${ds.alv}</div><div style="font-size:.72rem">‚öîÔ∏è${ds.power} üí®${ds.speed} üß†${ds.wisdom} ‚ù§Ô∏è${ds.hp}</div></div></div>`}}
h+='<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn bs bsm" id="col">üì¶ Collection</button><button class="btn bs bsm" id="dsh">üõí Shop</button></div><div class="sg">';
if(!p.dg.ow.length)h+='<div style="grid-column:1/-1;text-align:center;padding:20px;opacity:.5">Visit the shop!</div>';
else p.dg.ow.forEach(id=>{const ds=S.ds(id);if(!ds)return;const el=EL[ds.e],act=p.dg.ac===id;h+=`<div class="dc r${ds.r[0]}" data-dg="${id}" style="cursor:pointer"><span class="de">${ds.em}</span><div class="dn">${ds.dn}</div><div class="dl">${el.i}${el.n}</div>${act?'<div style="font-size:.62rem;color:var(--gold);margin-top:3px">‚≠êActive</div>':''}</div>`});
h+='</div></div>';sc().innerHTML=h;$('dsh').addEventListener('click',showDS);$('col').addEventListener('click',showDr);
sc().querySelectorAll('[data-dg]').forEach(c=>c.addEventListener('click',()=>showDD(+c.dataset.dg)))}
function showDS(){const p=S.pf();let h=`<div><h2 class="sh">üõí Dragon Shop</h2><p class="ss">ü™ô${p.co}</p><div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn bs bsm" id="col2">üì¶ Collection</button><button class="btn bs bsm" id="dsh2">üõí Shop</button></div>`;
['flame','tide','forest','storm','frost','shadow'].forEach(el=>{const e=EL[el],ds=DR.filter(d=>d.e===el);h+=`<div style="margin-bottom:16px"><div style="font-family:var(--fd);color:${e.c};margin-bottom:6px">${e.i}${e.n}</div><div class="sg">`;
ds.forEach(d=>{const ow=p.dg.ow.includes(d.id),cost=RA[d.r].cost;h+=`<div class="dc r${d.r[0]}" data-sd="${d.id}" style="cursor:pointer"><span style="font-size:1.8rem">${d.em}</span><div style="font-family:var(--fd);font-size:.75rem;margin-top:3px">${d.n}</div><div style="font-size:.62rem;opacity:.6">${RA[d.r].l}</div>${ow?'<div style="font-size:.68rem;color:var(--green);margin-top:3px">‚úÖ</div>':`<div style="font-family:var(--fd);color:var(--gold);font-size:.78rem;margin-top:3px">ü™ô${cost}</div>`}</div>`});h+='</div></div>'});
h+='</div>';sc().innerHTML=h;$('col2').addEventListener('click',showDr);$('dsh2').addEventListener('click',showDS);
sc().querySelectorAll('[data-sd]').forEach(c=>c.addEventListener('click',()=>{const id=+c.dataset.sd,p=S.pf();if(p.dg.ow.includes(id)){showDD(id);return}const d=gd(id),cost=RA[d.r].cost;
md(`Buy ${d.n}?`,`<div style="font-size:2.2rem">${d.em}</div><p style="font-size:.85rem;opacity:.8">${d.fl[0]}</p><p style="color:var(--gold);font-family:var(--fd)">ü™ô${cost}</p>`,[{l:'Buy!',f:()=>{if(!S.sc(cost)){md('Need More!',`ü™ô${cost}`,[{l:'OK'}]);return}S.od(id);A.p('rr');tt(9);ub();md('üêâ New Dragon!',`<div style="font-size:2.5rem">${d.em}</div><div style="font-family:var(--fd);color:var(--gold)">${d.n}</div>`,[{l:'Awesome!',f:showDr}])}},{l:'Cancel',c:'bs'}])}))}
function showDD(id){const ds=S.ds(id);if(!ds)return;const p=S.pf(),el=EL[ds.e],isA=p.dg.ac===id,st=ds.stage;
let ev='';if(st<3){const bc=RA[ds.r].cost,nc=st===1?bc*2:bc*4,wn=st===1?3:5,cw=ds.ws,can=p.co>=nc&&cw>=wn;
ev=`<div class="card mt12 tc2"><div style="font-family:var(--fd);color:var(--gold);font-size:.85rem;margin-bottom:4px">${st===1?'‚Üí Awakened ‚ú¶':'‚Üí Ascended ‚ú¶‚ú¶'}</div><div style="font-size:.78rem">ü™ô${nc} ¬∑ ${cw}/${wn} wins</div><button class="btn bp bsm mt8" id="evb" ${can?'':'disabled'}>${can?'Evolve!':'Not Ready'}</button></div>`}
let ar='';if(ds.alv<5){const nx=AR[ds.alv+1],can=p.co>=nx.cost;ar=`<div class="card mt12 tc2"><div style="font-family:var(--fd);font-size:.85rem">üõ°Ô∏èArmor ${ds.alv}/5</div><div style="font-size:.78rem">Next:+${nx.hp}HP ${Math.round(nx.dr*100)}%DR ü™ô${nx.cost}</div><button class="btn bs bsm mt8" id="arb" ${can?'':'disabled'}>${can?'Upgrade':'Need Coins'}</button></div>`}
else ar='<div class="card mt12 tc2"><div style="font-family:var(--fd);color:var(--gold)">üõ°Ô∏è MAX ARMOR!</div></div>';
const frLv=ds.fr;let frMsg='';if(frLv>=80)frMsg='üíï Best Friends!';else if(frLv>=50)frMsg='üíó Good Friends';else if(frLv>=20)frMsg='üíõ Getting Closer';else frMsg='üí≠ Getting to Know';
const frQ=['*yawns sleepily*','*nudges your hand*','*purrs softly*','*does a happy dance*','*breathes tiny hearts*'][Math.min(4,Math.floor(frLv/20))];
sc().innerHTML=`<div class="tc2"><button class="btn bs bsm mb16" id="ddbk" style="float:left">‚Üê Back</button><div style="clear:both"></div><div style="font-size:4rem;margin:8px 0">${ds.em}</div><div style="font-family:var(--fd);font-size:1.4rem;color:var(--gold)">${ds.dn}</div><div style="font-size:.85rem;opacity:.7;margin:4px 0">${el.i}${el.n} ¬∑ ${RA[ds.r].l} ¬∑ Stg${st}</div><div style="font-size:.85rem;font-style:italic;opacity:.6;margin:8px 0">"${ds.fv}"</div><div class="card mt12" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:left;font-size:.9rem"><span>‚öîÔ∏è${ds.power}</span><span>üí®${ds.speed}</span><span>üß†${ds.wisdom}</span><span>üíñ${ds.charm}</span><span>‚ù§Ô∏è${ds.hp}</span><span>üèÜ${ds.ws} wins</span></div><div class="card mt12 tc2"><div style="font-family:var(--fd);font-size:.85rem">‚ú®${el.pw}</div></div><div class="card mt12 tc2"><div style="font-size:.78rem">${frMsg} (${frLv}/100)</div><div style="height:4px;background:rgba(255,255,255,.1);border-radius:2px;margin:4px 0"><div style="height:100%;background:linear-gradient(90deg,var(--purple-l),var(--gold));border-radius:2px;width:${frLv}%"></div></div><div style="font-size:.75rem;font-style:italic;opacity:.5;margin-top:4px">${frQ}</div></div>${!isA?`<button class="btn bp mt12" id="sab">Set Active</button>`:'<div class="mt12" style="color:var(--gold);font-family:var(--fd)">‚≠ê Active Dragon</div>'}${ev}${ar}</div>`;
$('ddbk').addEventListener('click',showDr);
const sab=$('sab');if(sab)sab.addEventListener('click',()=>{const p=S.pf();p.dg.ac=id;S.sp(p);A.p('cl');showDD(id);ub()});
const evb=$('evb');if(evb)evb.addEventListener('click',()=>{const p=S.pf(),bc=RA[ds.r].cost,nc=st===1?bc*2:bc*4;if(!S.sc(nc))return;p.dg.sg[id]=(p.dg.sg[id]||1)+1;S.sp(p);A.p('pw');cf();if(st+1===2)tt(10);if(st+1===3)tt(11);showDD(id)});
const arb=$('arb');if(arb)arb.addEventListener('click',()=>{const p=S.pf(),al=p.dg.ar[id]||0,nx=AR[al+1];if(!S.sc(nx.cost))return;p.dg.ar[id]=al+1;S.sp(p);A.p('cn');ub();if(al===0)tt(12);if(al+1===5)tt(13);showDD(id)})}
function showIS(){const p=S.pf();let h=`<div><h2 class="sh">üß™ Items</h2><button class="btn bs bsm mb12" id="isb2">‚Üê Back</button><p class="ss">ü™ô${p.co}</p><div class="sg">`;
for(const[k,it]of Object.entries(IT)){const ow=p.an.it[k]||0;h+=`<div class="dc rb" data-buy="${k}" style="cursor:pointer"><span style="font-size:1.8rem">${it.ic}</span><div style="font-family:var(--fd);font-size:.8rem;margin-top:4px">${it.n}</div><div style="font-size:.7rem;opacity:.7">${it.d}</div><div style="font-size:.72rem;margin-top:4px">Own:${ow}</div><div style="font-family:var(--fd);color:var(--gold);font-size:.85rem;margin-top:4px">ü™ô${it.cost}</div></div>`}
h+='</div></div>';sc().innerHTML=h;$('isb2').addEventListener('click',showAr);
sc().querySelectorAll('[data-buy]').forEach(c=>c.addEventListener('click',()=>{const k=c.dataset.buy,it=IT[k];if(!S.sc(it.cost)){md('Need More Coins!',`ü™ô${it.cost}`,[{l:'OK'}]);return}const p=S.pf();p.an.it[k]=(p.an.it[k]||0)+1;S.sp(p);A.p('cn');ub();showIS()}))}
// === TROPHIES ===
function showTr(){const p=S.pf();if(!p)return;let h=`<div><h2 class="sh">üèÜ Trophies</h2><p class="ss">${p.tp.length}/${TR.length} unlocked</p><div class="tg">`;
TR.forEach(t=>{const u=p.tp.includes(t.id);h+=`<div class="ti ${u?'ul':'lo'}" ${u?`data-tr="${t.id}"`:''} style="cursor:${u?'pointer':'default'}"><span class="tic">${t.i}</span><div class="tn">${u?t.n:'???'}</div></div>`});
h+='</div></div>';sc().innerHTML=h;
if(p.tp.length>=TR.length-1)tt(32);
sc().querySelectorAll('[data-tr]').forEach(el=>el.addEventListener('click',()=>{const t=TR.find(x=>x.id===+el.dataset.tr);if(t)md(t.n,`<div style="font-size:3rem">${t.i}</div><p>${t.d}</p>`,[{l:'Nice!'}])}))}
// === SETTINGS ===
function showSt(){const p=S.pf();if(!p)return;sc().innerHTML=`<div><h2 class="sh">‚öôÔ∏è Settings</h2>
<div style="margin-bottom:20px"><h3 style="font-family:var(--fd);font-size:1rem;color:var(--gold);margin-bottom:10px">üîä Sound</h3><div class="sr"><label>Sound Effects</label><label class="tgl"><input type="checkbox" id="sndtg" ${p.set.snd?'checked':''}><span class="sl"></span></label></div></div>
<div style="margin-bottom:20px"><h3 style="font-family:var(--fd);font-size:1rem;color:var(--gold);margin-bottom:10px">üë§ Profile</h3><div class="card tc2"><div style="font-family:var(--fd);color:var(--gold)">${esc(p.pl.nm)}</div><div style="font-size:.85rem;opacity:.7">Age ${p.pl.ag} ¬∑ ${gr(p.xp).title}</div><div style="font-size:.8rem;margin-top:8px">‚ö°LifeXP:${p.xp} ü™ôTotal:${p.tc}</div><div style="font-size:.8rem">‚úÖ${p.st.c}/${p.st.a} correct ¬∑ üî•Best:${p.st.bs}</div></div></div>
<div style="margin-bottom:20px"><h3 style="font-family:var(--fd);font-size:1rem;color:var(--gold);margin-bottom:10px">üë®‚Äçüë©‚Äçüëß Parent Dashboard</h3><button class="btn bs wf" id="pdash">üîí Open Dashboard</button></div>
<div style="margin-bottom:20px"><h3 style="font-family:var(--fd);font-size:1rem;color:var(--gold);margin-bottom:10px">üë• Profiles</h3><button class="btn bs wf" id="swpr">Switch Profile</button></div>
<div><h3 style="font-family:var(--fd);font-size:1rem;color:var(--gold);margin-bottom:10px">üíæ Data</h3><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn bs bsm" id="exp">üì§ Export</button><button class="btn bs bsm" id="imp">üì• Import</button><button class="btn bd bsm" id="rst">üóëÔ∏è Reset</button></div></div></div>`;
$('sndtg').addEventListener('change',e=>{const p=S.pf();p.set.snd=e.target.checked;S.sp(p);A.m=!e.target.checked;$('mb').textContent=A.m?'üîá':'üîä'});
$('swpr').addEventListener('click',()=>{S.sa(null);sessionStorage.removeItem('ap');showPr()});
$('pdash').addEventListener('click',()=>{md('üîí PIN Required','Enter your 4-digit parent PIN:'+`<input type="password" class="inf" id="pdpin" maxlength="4" style="max-width:160px;text-align:center;font-size:1.3rem;letter-spacing:6px;margin-top:10px" inputmode="numeric">`,[{l:'Open',f:()=>{const v=document.getElementById('pdpin')?.value;if(S.vp(v))showParentDash();else md('Wrong PIN','Try again.',[{l:'OK'}])}},{l:'Cancel',c:'bs'}])});
$('exp').addEventListener('click',()=>{const j=JSON.stringify(S.dt(),null,2),b=new Blob([j],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='dragon-math-backup.json';a.click();URL.revokeObjectURL(u)});
$('imp').addEventListener('click',()=>{const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.pr){S.sv(d);md('Import OK!','Data restored.',[{l:'OK',f:()=>location.reload()}])}else throw 0}catch(e){md('Failed','Invalid file.',[{l:'OK'}])}};r.readAsText(f)};i.click()});
$('rst').addEventListener('click',()=>md('‚ö†Ô∏è Reset?','Delete ALL progress for this profile?',[{l:'Delete',c:'bd',f:()=>{const id=S.gi();S.dl(id);S.sa(null);showPr()}},{l:'Cancel',c:'bs'}]))}
// === PARENT DASHBOARD ===
function showParentDash(){const p=S.pf();if(!p)return;
const acc=p.st.a>0?Math.round(p.st.c/p.st.a*100):0;
const trackADone=S.hl();
let tbDone=0;TB_GRADES.forEach(g=>{tbDone+=S.hlb(g.id)});
const dragons=p.dg.ow.length;
const arenaW=p.an.w,arenaL=p.an.l;
const bossesBeaten=p.an.bk?Object.keys(p.an.bk).length:0;
const mpW=p.mp.w,mpL=p.mp.l;
const trophies=p.tp.length;
// Strength/weakness analysis
let strengths=[],weaknesses=[];
if(p.st.mc>p.st.dc+10)strengths.push('Multiplication');else if(p.st.dc>p.st.mc+10)strengths.push('Division');
if(p.st.ac>25)strengths.push('Addition');
if(p.st.sc>25)strengths.push('Subtraction');
if(acc>=80)strengths.push('High accuracy ('+acc+'%)');
if(p.st.bs>=10)strengths.push('Great streaks');
if(p.st.mc<p.st.dc&&p.st.mc<20)weaknesses.push('Needs multiplication practice');
if(p.st.dc<p.st.mc&&p.st.dc<20)weaknesses.push('Needs division practice');
if(acc<60&&p.st.a>20)weaknesses.push('Accuracy below 60%');
if(p.st.bs<3&&p.st.a>30)weaknesses.push('Consistency (low streaks)');
sc().innerHTML=`<div><h2 class="sh">üë®‚Äçüë©‚Äçüëß Parent Dashboard</h2><button class="btn bs bsm mb12" id="pdbk">‚Üê Back</button>
<div class="card mb12"><div style="font-family:var(--fd);color:var(--gold);margin-bottom:8px">üìä ${esc(p.pl.nm)}'s Progress</div>
<div class="parent-stat"><span>Age</span><span>${p.pl.ag}</span></div>
<div class="parent-stat"><span>Rank</span><span>${gr(p.xp).title}</span></div>
<div class="parent-stat"><span>Total XP</span><span>‚ö°${p.xp}</span></div>
<div class="parent-stat"><span>Total Coins Earned</span><span>ü™ô${p.tc}</span></div>
<div class="parent-stat"><span>Login Streak</span><span>üî•${p.pl.sk} days</span></div>
</div>
<div class="card mb12"><div style="font-family:var(--fd);color:var(--gold);margin-bottom:8px">üìù Math Skills</div>
<div class="parent-stat"><span>Problems Attempted</span><span>${p.st.a}</span></div>
<div class="parent-stat"><span>Correct Answers</span><span>${p.st.c}</span></div>
<div class="parent-stat"><span>Accuracy</span><span>${acc}%</span></div>
<div class="parent-stat"><span>Best Streak</span><span>üî•${p.st.bs}</span></div>
<div class="parent-stat"><span>Multiplication Correct</span><span>‚úñÔ∏è${p.st.mc}</span></div>
<div class="parent-stat"><span>Division Correct</span><span>‚ûó${p.st.dc}</span></div>
<div class="parent-stat"><span>Addition Correct</span><span>‚ûï${p.st.ac||0}</span></div>
<div class="parent-stat"><span>Subtraction Correct</span><span>‚ûñ${p.st.sc||0}</span></div>
<div class="parent-stat"><span>Perfect Levels (‚≠ê‚≠ê‚≠ê)</span><span>‚≠ê${p.st.pl||0}</span></div>
</div>
<div class="card mb12"><div style="font-family:var(--fd);color:var(--gold);margin-bottom:8px">üó∫Ô∏è Progress</div>
<div class="parent-stat"><span>Track A (Mult/Div)</span><span>${trackADone}/50 levels</span></div>
<div class="parent-stat"><span>Track B (Math Trail)</span><span>${tbDone}/45 levels</span></div>
<div class="parent-stat"><span>Dragons Owned</span><span>üêâ${dragons}/30</span></div>
<div class="parent-stat"><span>Trophies</span><span>üèÜ${trophies}/${TR.length}</span></div>
</div>
<div class="card mb12"><div style="font-family:var(--fd);color:var(--gold);margin-bottom:8px">‚öîÔ∏è Battle Record</div>
<div class="parent-stat"><span>Solo Arena</span><span>W:${arenaW} L:${arenaL}</span></div>
<div class="parent-stat"><span>Bosses Beaten</span><span>üíÄ${bossesBeaten}/6</span></div>
<div class="parent-stat"><span>Multiplayer</span><span>W:${mpW} L:${mpL}</span></div>
</div>
${strengths.length?`<div class="card mb12"><div style="font-family:var(--fd);color:var(--green);margin-bottom:6px">üí™ Strengths</div>${strengths.map(s=>`<div style="font-size:.82rem;padding:3px 0">‚úÖ ${s}</div>`).join('')}</div>`:''}
${weaknesses.length?`<div class="card mb12"><div style="font-family:var(--fd);color:var(--gold);margin-bottom:6px">üéØ Areas to Practice</div>${weaknesses.map(w=>`<div style="font-size:.82rem;padding:3px 0">üìå ${w}</div>`).join('')}</div>`:''}
</div>`;
$('pdbk').addEventListener('click',showSt)}
// === PRACTICE ===
let pst=null;
function showPrac(){sc().innerHTML=`<div class="tc2"><h2 class="sh">üéØ Practice</h2><p class="ss">Infinite rapid-fire! No XP/coins.</p><div style="margin:16px 0"><div style="font-family:var(--fd);margin-bottom:8px">Track A (Mult/Div):</div><div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">${TI.map((t,i)=>`<button class="btn bs bsm" data-pd="${i}">${t.n}</button>`).join('')}</div></div><div style="margin:16px 0"><div style="font-family:var(--fd);margin-bottom:8px">Track B:</div><div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">${TB_GRADES.map(g=>`<button class="btn bs bsm" data-pdb="${g.id}">${g.n.split(' ')[0]} ${g.id}</button>`).join('')}</div></div><button class="btn bs bsm mt16" id="pbk">‚Üê Back</button></div>`;
$('pbk').addEventListener('click',showH);
sc().querySelectorAll('[data-pd]').forEach(b=>b.addEventListener('click',()=>{pst={df:+b.dataset.pd,ok:0,tot:0,st:Date.now(),dn:false,track:'a'};rPr()}));
sc().querySelectorAll('[data-pdb]').forEach(b=>b.addEventListener('click',()=>{const g=TB_GRADES.find(x=>x.id===b.dataset.pdb);if(!g)return;pst={df:0,ok:0,tot:0,st:Date.now(),dn:false,track:'b',grade:g.id,lvs:g.lvs};rPr()}))}
function rPr(){if(!pst)return;pst.dn=false;
const pb=pst.track==='a'?gp(TI[pst.df].lv[0]):gpb(pst.lvs[ri(0,pst.lvs.length-1)]);
pst._p=pb;const el=Math.floor((Date.now()-pst.st)/1000);
sc().innerHTML=`<div class="tc2"><div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:.8rem;opacity:.6"><span>‚úÖ${pst.ok}</span><span>‚è±Ô∏è${el}s</span><span>üìä${pst.tot>0?Math.round(pst.ok/pst.tot*100):0}%</span></div><div style="font-family:var(--fd);font-size:2.4rem;margin:18px 0">${pb.d}</div><div id="ab" style="font-family:var(--fd);font-size:2rem;color:var(--gold);min-height:44px;border-bottom:3px solid var(--gold);display:inline-block;min-width:90px;padding:4px 8px;margin-bottom:8px"></div>${pb.mc?mcHTML(pb.mc):np()}<button class="btn bs bsm mt16" id="psp">Stop</button></div>`;
$('psp').addEventListener('click',showPrac);
if(pb.mc){nph=null;sc().querySelectorAll('[data-mc]').forEach(b=>b.addEventListener('click',()=>{if(pst.dn)return;pst.dn=true;pst.tot++;const ok=+b.dataset.mc===pb.an;if(ok){pst.ok++;A.p('ok')}else A.p('no');setTimeout(rPr,600)}))}
else{nph=v=>{if(pst.dn)return;const b=$('ab');if(!b)return;if(v==='back'){b.textContent=b.textContent.slice(0,-1);return}if(v==='enter'){const u=parseInt(b.textContent);if(isNaN(u))return;pst.dn=true;pst.tot++;if(u===pst._p.an){pst.ok++;A.p('ok')}else A.p('no');setTimeout(rPr,600);return}if(b.textContent.length<6){b.textContent+=v;A.p('cl')}}}}
// === BOOT ===
document.addEventListener('DOMContentLoaded',()=>{A.init();const id=S.gi();if(id){const p=S.pf();if(p&&p.pl.ob)enterApp();else showPr()}else showPr()});
</script></body></html>
